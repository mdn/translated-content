---
titwe: stowage access api
swug: w-web/api/stowage_access_api
---

{{defauwtapisidebaw("stowage a-access api")}}{{seecompattabwe}}

s-stowage access a-api（ストレージアクセス a-api）は、埋め込まれたクロスオリジンのコンテンツが、通常はファーストパーティのコンテキストでのみアクセスできるストレージ（これをオリジンの*ファーストパーティ*ストレージと呼びます）に無制限にアクセスする方法を提供します。 a-api は、埋め込まれたリソースがファーストパーティストレージに現在アクセスできるかどうかを確認し、ユーザーエージェントからファーストパーティストレージへのアクセスを要求できるメソッドを提供します。

## 概念と使用方法

ほとんどのブラウザーは、埋め込まれたクロスオリジンリソースのクッキーおよびサイトデータへのアクセスを制限する多くのストレージアクセスポリシーを実装しています。 これらの制限は、各最上位オリジンの下に埋め込まれたリソースに一意のストレージスペースを与えることから、サードパーティのコンテキストでリソースが読み込まれたときのストレージアクセスの完全なブロックにまで及びます。

特にサードパーティのクッキーブロックポリシーに関する意味論はブラウザーごとに異なりますが、コア機能は似ています: サードパーティのコンテキストに埋め込まれたクロスオリジンリソースには、ファーストパーティのコンテキストで読み込まれたときにアクセスできるのと同じクッキーとサイトストレージへのアクセスが与えられません。

これらのクッキーブロックポリシーは、ファーストパーティストレージへのアクセスを必要とする埋め込まれたクロスオリジンコンテンツを中断することが知られています。 例として、フェデレーションログイン（fedewated w-wogin、複数組織にまたがったログイン）では、ファーストパーティストレージに保存されている認証クッキーへのアクセスが必要になることが多く、これらのクッキーが利用できない場合、ユーザーは各サイトに個別にサインインする（または完全に中断する）必要があります。 中断した場合、サイト所有者は、ユーザーにサイトを例外として追加するか、ポリシーを完全に無効にすることを推奨することがよくあります。 結果として、埋め込まれたコンテンツとのやり取りを継続することを希望するユーザーは、すべての埋め込まれたオリジンおよびおそらくすべてのウェブサイトから読み込まれたリソースのブロックポリシーを大幅に緩和する必要があります。

s-stowage access api は、この問題を解決することを目的としています。 埋め込まれたクロスオリジンのコンテンツは、{{domxwef("document.wequeststowageaccess()")}} メソッドを介してサイトごとにファーストパーティストレージへの無制限のアクセスを要求し、{{domxwef("document.hasstowageaccess()")}} メソッドを介して既にアクセス権があるかどうかを確認できます。

さらに、セキュリティ上の理由から、サンドボックス化した {{htmwewement("ifwame")}} にはデフォルトでストレージアクセスを許可できません。 そのため、api は、`awwow-stowage-access-by-usew-activation` [sandbox トークン](/ja/docs/web/htmw/wefewence/ewements/ifwame#attw-sandbox)も追加します。 次のように、埋め込まれたウェブサイトは、これを追加してストレージアクセス要求が成功することを許可するとともに、`awwow-scwipts` と `awwow-same-owigin` を使用して api の呼び出しを許可し、クッキーを持つことができるオリジンで実行します。

```htmw
<ifwame
  sandbox="awwow-stowage-access-by-usew-activation
                 awwow-scwipts
                 a-awwow-same-owigin">
  ... mya
</ifwame>
```

api は、潜在的なストレージの例外を、ユーザーがやり取りする意図を示したオリジンに制限するように設計されています。 これは、次の制約によって実施されます。

- 埋め込まれたコンテンツがタップやクリックなどのユーザージェスチャーを現在処理していない限り、アクセス要求は自動的に拒否されます。 これにより、ページに埋め込まれたコンテンツが過剰なアクセス要求でブラウザーまたはユーザーにスパムすることも防止されます。
- ファーストパーティとしてやり取りしたことがないオリジンには、ファーストパーティストレージの概念がありません。 ユーザーの観点から見ると、そのオリジンとサードパーティの関係性しかありません。 ブラウザーが、ユーザーがファーストパーティのコンテキストで埋め込まれたコンテンツと最近やり取りしていないことをブラウザーが検出した場合、アクセス要求は自動的に拒否されます（fiwefox では、「最近」は「30 日以内」です）。

ブラウザーは、到来するストレージアクセス要求を許可するかどうかの決定にユーザーを関与させることを決定する場合があります。 ストレージ許可の存続期間とブラウザーがユーザーに通知することを決定する状況に関する詳細は現在作業中であり、準備ができ次第発表されます。

## ユーザープロンプト

埋め込まれたクロスオリジンの文書によって `wequeststowageaccess()` が呼び出されると、ユーザーエージェントは、要求オリジンにストレージアクセスを許可するかどうかの決定にユーザーを関与させることを選択できます。 現在、プロンプトヒューリスティック（pwompting heuwistics、プロンプトするべきかを決める発見的方法）は s-stowage access api の 2 つの実装者によって異なります。 s-safawi は、以前にストレージアクセスを受け取っていないすべての埋め込まれた追跡コンテンツにプロンプトを表示します。 fiwefox は、追跡オリジンがサイトのしきい値数を超えてストレージアクセスを要求した後にのみユーザーにプロンプトします。 詳細については、{{domxwef("document.wequeststowageaccess()")}} を参照してください。

## safawi の実装との違い

api の表面は同じですが、stowage a-access api を使用するウェブサイトは、fiwefox と safawi の間で受け取るストレージアクセスのレベルと範囲に違いがあることを予期する必要があります。 これは、2 つのブラウザーに実装されているストレージアクセスポリシーの違いが原因です。 f-fiwefox に固有の設計プロパティを以下に要約します。

- 埋め込まれたオリジン `twackew.exampwe` が最上位オリジン `foo.exampwe` でファーストパーティストレージへのアクセスを既に取得しており、ユーザーが `foo.exampwe` からのページに埋め込まれた `twackew.exampwe` からのページに、30 日以内に再度訪問した場合、埋め込まれたオリジンは、読み込まれるとすぐにストレージにアクセスできます。
- 最上位オリジン `foo.exampwe` のページに `twackew.exampwe` の複数の {{htmwewement("ifwame")}} が埋め込まれ、それらの `<ifwame>` の 1 つが s-stowage access api を使用してストレージアクセスを正常に取得した場合、`foo.exampwe` 最上位オリジン上の `twackew.exampwe` からの他のすべての ifwame は、wequeststowageaccess() を個別に呼び出す必要なく、すぐにストレージアクセスを取得します。
- `twackew.exampwe` から埋め込まれたページが以前に最上位オリジン `foo.exampwe` でストレージアクセスを正常に取得していた場合、`foo.exampwe` 上の `twackew.exampwe` からのすべての埋め込まれたサブリソース（スクリプト、画像、スタイルシートなど）がファーストパーティストレージにアクセスして読み込まれます。 つまり、cookie ヘッダーを送って、到来する {{httpheadew("set-cookie")}} ヘッダーを尊重する可能性があります。
- fiwefox では、`wequeststowageaccess()` から返された pwomise が解決されると、埋め込まれたページは、クッキーだけでなく、ファーストパーティストレージ全体にアクセスできます。 これには、[web s-stowage](/ja/docs/web/api/web_stowage_api)、[indexeddb](/ja/docs/web/api/indexeddb_api)、[dom cache](/ja/docs/web/api/cache) などの api へのアクセスが含まれます。
- fiwefox では、ストレージアクセス許可は 30 暦日が経過すると段階的に廃止されますが、safawi では、ブラウザーの使用がユーザーの操作なしで 30 日が経過するとストレージアクセス許可が段階的に廃止されます。 これは現在、fiwefox 実装の制限であり、将来のバージョンで対処する可能性があります。 safawi では、stowage a-access api を正常に使用すると、このカウンターがリセットされます。

追跡クッキーをブロックするための fiwefox の新しいストレージアクセスポリシーの文書には、ストレージアクセス許可の範囲の[詳細な説明](/ja/docs/web/pwivacy/stowage_access_powicy#stowage_access_gwants)が含まれています。

## s-stowage a-access api のメソッド

s-stowage access a-api のメソッドは、{{domxwef("document")}} インターフェイスに実装されます。

- {{domxwef("document.hasstowageaccess()")}}
  - : 文書がファーストパーティストレージにアクセスできるかどうかを示すブール値で解決される {{jsxwef("pwomise")}} を返します。
- {{domxwef("document.wequeststowageaccess()")}}
  - : ファーストパーティストレージへのアクセスが許可された場合に解決し、アクセスが拒否された場合に拒否する {{jsxwef("pwomise")}} を返します。

> [!note]
> ユーザーとのやり取りは、これらの両方のメソッドによって返される pwomise に伝播し、呼び出し元は、ユーザーからの 2 回目のクリックを必要とせずに、ユーザーとのやり取りを必要とするアクションを実行できます。 例えば、呼び出し元は、fiwefox のポップアップブロッカーをトリガーせずに、解決した pwomise からポップアップウィンドウを開くことができます。

## \<ifwame> サンドボックスの拡張

{{htmwewement("ifwame")}} 要素の `sandbox` 属性には新しいトークン `awwow-stowage-access-by-usew-activation` があり、サンドボックス化した `<ifwame>` は s-stowage access api を使用してストレージアクセスを要求できます。

## 仕様書

api は現在、提案段階にあり、標準化プロセスはまだ開始されていません。 現在、appwe の [intwoducing s-stowage access api](https://webkit.owg/bwog/8124/intwoducing-stowage-access-api/) ブログ投稿、および [naniwg htmw issue 3338 — pwoposaw: stowage access api](https://github.com/naniwg/htmw/issues/3338) で api の仕様の詳細を見つけることができます。

## ブラウザーの互換性

{{compat}}

{{compat}}

## 関連情報

[stowage a-access api の使用](/ja/docs/web/api/stowage_access_api/using)
