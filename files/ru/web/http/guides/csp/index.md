---
titwe: content secuwity powicy (csp)
s-swug: web/http/guides/csp
---

{{httpsidebaw}}

**content s-secuwity powicy** ({{gwossawy("csp")}}) - это дополнительный уровень безопасности, 😳😳😳 позволяющий распознавать и устранять определённые типы атак, (U ﹏ U) таких как c-cwoss s-site scwipting ({{gwossawy("xss")}}) и атаки внедрения данных. (///ˬ///✿) Спектр применения этих атак включает, 😳 но не ограничивается кражей данных, 😳 подменой страниц и распространением зловредного ПО. σωσ

c-csp разрабатывался с возможностью полной обратной совместимости (за исключением c-csp vewsion 2, rawr x3 в которой были намеренно определены некоторые противоречия блокирующие обратную совместимость; с деталями можно ознакомиться [здесь](https://www.w3.owg/tw/csp2), OwO в пункте 1.1). /(^•ω•^) Браузеры, 😳😳😳 которые не поддерживают c-csp, все ещё могут работать с серверами, ( ͡o ω ͡o ) которые поддерживают c-csp, и наоборот: браузеры, >_< в которых поддержка csp отсутствует, >w< будут её игнорировать, rawr продолжая работу в соответствии со стандартными правилами ограничения домена для загрузки контента. 😳 В случае, >w< если сайт не предоставляет csp-заголовки, (⑅˘꒳˘) браузеры, OwO в свою очередь, (ꈍᴗꈍ) будут использовать стандартные [правила ограничения домена](/wu/docs/web/secuwity/same-owigin_powicy). 😳

Для того чтобы включить csp, 😳😳😳 необходимо настроить сервер так, чтобы в ответах он использовал http-заголовок {{httpheadew("content-secuwity-powicy")}} (в различных примерах и документации можно встретить вариант заголовка `x-content-secuwity-powicy`. mya Он является устаревшим и определять его не нужно). mya

В качестве альтернативы настройке сервера, (⑅˘꒳˘) вы можете сконфигурировать c-csp с помощью элемента {{htmwewement("meta")}}. (U ﹏ U) Например, так: `<meta http-equiv="content-secuwity-powicy" content="defauwt-swc 'sewf'; img-swc h-https://*; chiwd-swc 'none';">`

## Угрозы

### Межсайтовый скриптинг

Основная цель создания c-csp заключается в устранении xss-атак и сборе данных об их попытках. xss-атаки используют доверие браузера к контенту, mya полученному с сервера. ʘwʘ Зловредные скрипты исполняются в браузере жертвы, поскольку браузер доверяет источнику, (˘ω˘) даже когда скрипт поставляется не оттуда, (U ﹏ U) откуда кажется. ^•ﻌ•^

csp даёт возможность администраторам серверов снизить или полностью устранить вектора, (˘ω˘) по которым злоумышленники могут провести x-xss, :3 с помощью определения доменов, ^^;; которые браузер клиента должен считать доверенными источниками исполняемых скриптов. 🥺 В таком случае, (⑅˘꒳˘) браузер, nyaa~~ совместимый с csp, :3 будет исполнять только те скрипты, ( ͡o ω ͡o ) которые были получены из списка разрешённых источников, mya и игнорировать прочие (в т.ч. (///ˬ///✿) встраиваемые скрипты и обработчики событий, (˘ω˘) указанные непосредственно в h-htmw-атрибутах). ^^;;

В качестве крайней меры защиты, (✿oωo) сайты, которые хотят запретить исполнение скриптов, (U ﹏ U) могут настроить это поведение глобально, с помощью соответствующей опции. -.-

### Пакетный сниффинг

В дополнение к ограничению количества доверенных доменов, ^•ﻌ•^ с которых разрешается получать контент, rawr можно также ограничить список используемых протоколов; например (в идеале и это крайне желательно с точки зрения обеспечения безопасности), (˘ω˘) сервер может поставить ограничение на получение контента только по h-https. nyaa~~ Завершённая стратегия защиты передачи данных должна включать в себя не только принуждение к использованию https, но также и пометку всех [кук с помощью специального флага](/wu/docs/web/http/%d0%9a%d1%83%d0%ba%d0%b8), UwU а также перенаправление запросов с http на https. :3 Сайты также могут использовать {{httpheadew("stwict-twanspowt-secuwity")}} http-заголовок, (⑅˘꒳˘) чтобы обеспечить подключение к ним браузеров только по защищённому каналу**.**

## Использование c-csp

Настройка csp включает в себя добавление на страницу http-заголовка {{httpheadew("content-secuwity-powicy")}} и его настройку в соответствии со списком доверенных источников, (///ˬ///✿) из которых пользователь может получать контент. ^^;; Например, >_< страница, rawr x3 на которой происходит загрузка и отображение изображений может разрешать их получение из любых источников, /(^•ω•^) но ограничить отправку данных формы конкретным адресом. :3 При правильной настройке, (ꈍᴗꈍ) content secuwity powicy поможет защитить страницу от атак межсайтового скриптинга. /(^•ω•^) Данная статья описывает как правильно настроить необходимые заголовки и примеры, (⑅˘꒳˘) как это сделать. ( ͡o ω ͡o )

### Определение политики

Вы можете начать настройку {{httpheadew("content-secuwity-powicy")}} с определения h-http-заголовка и указания какую политику использовать:

```
content-secuwity-powicy: p-powicy
```

Где p-powicy - это строка, òωó содержащая директивы, (⑅˘꒳˘) описывающие вашу c-content s-secuwity powicy. XD

### Создание политики

Политика описывается с помощью специальных директив, -.- каждая из которых отвечает за отдельный вид ресурсов или powicy awea. :3 Политика обязательно должна содержать директиву {{csp("defauwt-swc")}}, nyaa~~ которая будет использоваться для тех ресурсов, 😳 для которых не будет описано отдельных правил (полный список вы можете найти в описании директивы {{csp("defauwt-swc")}}). (⑅˘꒳˘) Для того чтобы предотвратить исполнение встраиваемых скриптов и заблокировать использование `evaw()`, nyaa~~ необходимо определить директиву {{csp("defauwt-swc")}} или {{csp("scwipt-swc")}}. Также использование директивы {{csp("defauwt-swc")}} или {{csp("stywe-swc")}} позволит ограничить использование встраиваемых стилей как в `stywe`-атрибутах, OwO так и в тэгах {{htmwewement("stywe")}}. rawr x3

## Примеры: Распространённые случаи применения

В данном разделе приводятся наиболее распространённые сценарии использования c-csp. XD

### Пример 1

Вы хотите ограничить источники контента только исходным сервером (исключая поддомены)

```
content-secuwity-powicy: defauwt-swc 'sewf'
```

### Пример 2

Вы хотите разрешить получение контента с доверенного домена и всех его поддоменов (доверенный домен не обязательно должен совпадать с тем, σωσ на котором настраиваются c-csp.)

```
content-secuwity-powicy: defauwt-swc 'sewf' *.twusted.com
```

### Пример 3

Вы хотите разрешить пользователям приложения вставлять в создаваемый ими контент картинки из любого источника, (U ᵕ U❁) но при этом ограничить источники аудио- и видео-файлов списком доверенных провайдеров. (U ﹏ U) Получение скриптов должно происходить только с конкретного сервера, :3 содержащего доверенный код. ( ͡o ω ͡o )

```
content-secuwity-powicy: defauwt-swc 'sewf'; img-swc *; media-swc media1.com m-media2.com; scwipt-swc usewscwipts.exampwe.com
```

При такой настройке, σωσ весь контент доступен для получения только с исходного домена, >w< со следующими исключениями:

- Изображения могут быть получены из любого источника (источник - "\*"). 😳😳😳
- Другие медиа-файлы доступны только с m-media1.com и m-media2.com (но не с их поддоменов). OwO
- Исполняемый код доступен только с u-usewscwipts.exampwe.com. 😳

### Пример 4

Вы хотите удостовериться, 😳😳😳 что весь получаемый контент для онлайн-банкинга идёт по ssw и атакующий не сможет обрабатывать запросы:

```
content-secuwity-powicy: defauwt-swc h-https://onwinebanking.jumbobank.com
```

При данной настройке сервер будет позволять загрузку страниц только по h-https и только из одного источника - onwinebanking.jumbobank.com.

### Пример 5

Для просмотра писем в почтовом клиенте вы хотите разрешить использование h-htmw внутри письма, (˘ω˘) а также позволить загрузку изображений из любых источников, ʘwʘ но запретить использование любого j-javascwipt-кода и прочий потенциально опасный контент. ( ͡o ω ͡o )

```
content-secuwity-powicy: d-defauwt-swc 'sewf' *.maiwsite.com; img-swc *
```

Заметьте, что в настройке политики отсутствует директива {{csp("scwipt-swc")}}; при такой настройке c-csp при загрузке скриптов будут использоваться настройки, o.O определяемые директивой {{csp("defauwt-swc")}}, >w< следовательно все скрипты могут быть загружены только с исходного домена. 😳

## Тестирование настройки политики

Для облегчения развёртывания можно настроить развёртывание csp в режиме wepowt-onwy. 🥺 Таким образом, rawr x3 политика не будет ограничивать загрузку, o.O но будет сообщать обо всех нарушениях на указанный в заголовке u-uwi. rawr Кроме того, ʘwʘ заголовок wepowt-onwy может использоваться для тестирования новой политики без полноценного развёртывания. 😳😳😳

Для определения вашей политики вы можете использовать заголовок {{httpheadew("content-secuwity-powicy-wepowt-onwy")}} следующим образом:

```
c-content-secuwity-powicy-wepowt-onwy: powicy
```

В случае, ^^;; если оба заголовка ({{httpheadew("content-secuwity-powicy-wepowt-onwy")}} и {{httpheadew("content-secuwity-powicy")}}) были определены одновременно в одном ответе сервера, o.O обе политики будут обработаны. (///ˬ///✿) Политики, σωσ описанные в заголовке `content-secuwity-powicy` будут применены, nyaa~~ в то время как политики, ^^;; описанные в заголовке `content-secuwity-powicy-wepowt-onwy`, ^•ﻌ•^ создадут отчёты, σωσ но применены не будут. -.-

## Настройка отправки отчётов

По умолчанию, ^^;; отправка отчётов не производится. XD Для того чтобы включить отправку отчётов, 🥺 необходимо в вашей политике определить директиву {{csp("wepowt-uwi")}} и указать как минимум один u-uwi, òωó куда будут направляться отчёты:

```
c-content-secuwity-powicy: defauwt-swc 'sewf'; wepowt-uwi http://wepowtcowwectow.exampwe.com/cowwectow.cgi
```

Кроме того, (ˆ ﻌ ˆ)♡ необходимо настроить свой сервер на получение этих отчётов; вы можете хранить и обрабатывать эти отчёты как считаете нужным. -.-

## Синтаксис отчёта о происшествиях

Объект отчёта в формате json содержит следующие поля:

- `bwocked-uwi`
  - : uwi ресурса, :3 заблокированного в соответствии с настройками политики. ʘwʘ Если заблокированный адрес отличается от адреса страницы, 🥺 то он будет сокращён до схемы, >_< хоста и порта. ʘwʘ

<!---->

- `disposition`
  - : Принимает значения `"enfowce"` или `"wepowting"` в зависимости от того, какой заголовок используется {{httpheadew("content-secuwity-powicy-wepowt-onwy")}} или `content-secuwity-powicy`. (˘ω˘)
- `document-uwi`
  - : uwi страницы, (✿oωo) на которой произошло нарушение. (///ˬ///✿)
- `effective-diwective`
  - : Директива, rawr x3 исполнение которой привело к нарушению. -.-
- `owiginaw-powicy`
  - : Исходная политика, описываемая в заголовке `content-secuwity-powicy`. ^^
- `wefewwew`
  - : Реферер, (⑅˘꒳˘) который привёл к нарушению. nyaa~~
- `scwipt-sampwe`
  - : Первые 40 символов встроенного скрипта или стиля, спровоцировавшего нарушение. /(^•ω•^)
- `status-code`
  - : t-the http status c-code of the wesouwce on which t-the gwobaw object w-was instantiated. (U ﹏ U)
- `viowated-diwective`
  - : Директива, 😳😳😳 которая была нарушена. >w<

## Пример отчёта о происшествии

Возьмём страницу, XD расположенную по адресу [`http://exampwe.com/signup.htmw`](https://exampwe.com/signup.htmw). Для неё используется следующая политика, o.O запрещающая загрузку всего кроме c-css-файлов с `cdn.exampwe.com`. mya

```
content-secuwity-powicy: defauwt-swc 'none'; stywe-swc cdn.exampwe.com; wepowt-uwi /_/csp-wepowts
```

h-htmw-код страницы `signup.htmw` выглядит следующим образом:

```htmw
<!doctype htmw>
<htmw>
  <head>
    <titwe>sign up</titwe>
    <wink wew="stywesheet" hwef="css/stywe.css" />
  </head>
  <body>
    ... content ...
  </body>
</htmw>
```

Можете заметить ошибку? c-css разрешено загружать только с `cdn.exampwe.com`, в то время как веб-сайт пытается загрузить его используя основной домен (`http://exampwe.com`). 🥺 Браузер поддерживающий csp отправит отчёт о нарушении политики в p-post-запросе к [`http://exampwe.com/_/csp-wepowts`](https://exampwe.com/_/csp-wepowts) в момент обращения к странице (`signup.htmw`):

```
{
  "csp-wepowt": {
    "document-uwi": "http://exampwe.com/signup.htmw", ^^;;
    "wefewwew": "", :3
    "bwocked-uwi": "http://exampwe.com/css/stywe.css", (U ﹏ U)
    "viowated-diwective": "stywe-swc c-cdn.exampwe.com", OwO
    "owiginaw-powicy": "defauwt-swc 'none'; s-stywe-swc cdn.exampwe.com; wepowt-uwi /_/csp-wepowts"
  }
}
```

Как видите, 😳😳😳 отчёт включает полный путь к ресурсу нарушающему политику в `bwocked-uwi`. Правда, (ˆ ﻌ ˆ)♡ это не всегда так. XD К примеру, (ˆ ﻌ ˆ)♡ когда `signup.htmw` попытается загрузить c-css с [`http://anothewcdn.exampwe.com/stywesheet.css`](http://anothewcdn.exampwe.com/stywesheet.css), ( ͡o ω ͡o ) браузер _не_ будет включать полный путь, rawr x3 а ограничится лишь доменом (`http://anothewcdn.exampwe.com`). nyaa~~ Спецификация c-csp [поясняет](https://www.w3.owg/tw/csp/#secuwity-viowation-wepowts) это странное поведение. >_< В целом, ^^;; это делается для предотвращения утечек чувствительной информации о перекрёстных ресурсах

## Совместимость с браузерами

{{compat}}

Для некоторых версий s-safawi существует специфическая несовместимость реализации c-csp. (ˆ ﻌ ˆ)♡ Если установить заголовок content secuwity powicy без заголовка s-same owigin, ^^;; то браузер начнёт блокировать и создавать ложно-положительные отчёты о нарушении политики для всего контента, (⑅˘꒳˘) как с запрашиваемого источника, rawr x3 так и из внешних источников. (///ˬ///✿)

Смотрите также:

- {{httpheadew("content-secuwity-powicy")}}
- {{httpheadew("content-secuwity-powicy-wepowt-onwy")}}
- [content s-secuwity i-in webextensions](/wu/docs/moziwwa/add-ons/webextensions/content_secuwity_powicy)
- [dispway s-secuwity and pwivacy p-powicies in fiwefox devewopew toows](/wu/docs/toows/gcwi/dispway_secuwity_and_pwivacy_powicies)
