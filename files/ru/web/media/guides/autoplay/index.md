---
title: Руководство по автозапуску для медиа и Web Audio API
slug: Web/Media/Guides/Autoplay
l10n:
  sourceCommit: e9b6cd1b7fa8612257b72b2a85a96dd7d45c0200
---

Автоматический запуск воспроизведения аудио (или видео с аудио-дорожками) сразу после загрузки страницы может стать нежелательным сюрпризом для пользователей. Хотя автозапуск медиа может быть полезным, его следует использовать осторожно и только при необходимости. Чтобы предоставить пользователям контроль над этим, браузеры часто реализуют различные механизмы блокировки автозапуска. В этом руководстве мы рассмотрим функциональность автозапуска в различных медиа и Web Audio API, включая краткий обзор использования автозапуска и способов корректной работы с блокировкой автозапуска в браузерах.

Блокировка автозапуска _не_ применяется к элементам {{HTMLElement("video")}}, если источник медиа не содержит аудиодорожки или она отключена (muted). Медиа с активной аудиодорожкой считаются **звуковым**, и для них действует блокировка автозапуска. **Беззвучные** медиа блокировка автозапуска не затрагивает.

## Автозапуск и блокировка автозапуска

Термин **автозапуск** обозначает любую функцию, которая запускает воспроизведение медиа без явного запроса пользователя. Это включает как использование HTML-атрибутов для автозапуска, так и вызов JavaScript-кода вне контекста обработки пользовательского ввода.

По этой причине оба приведённых ниже примера считаются автозапуском и могут быть заблокированы согласно политикам автозапуска браузеров:

```html
<audio src="/music.mp3" autoplay></audio>
```

and

```js
audioElement.play();
```

Ниже перечислены веб-функции и API, которые могут быть затронуты блокировкой автозапуска:

- Элементы {{Glossary("HTML")}} {{HTMLElement("audio")}} and {{HTMLElement("video")}}
- Интерфейс [Web Audio API](/ru/docs/Web/API/Web_Audio_API)

С точки зрения пользователя, внезапно начавшее издавать звук веб-приложение может быть неприятным или отвлекающим. Поэтому браузеры обычно разрешают автозапуск только в определённых условиях.

### Доступность автозапуска

В общем случае медиа будет разрешено автозапускать только если _хотя бы одно_ из следующих условий выполнено:

- Звук отключён или его громкость установлена на 0
- Пользователь взаимодействовал со страницей (клики, касания, нажатия клавиш и т. д.)
- Сайт включён в список разрешенных сайтов (allowlist); это может произойти автоматически (если браузер определит, что пользователь часто взаимодействует с медиа) или вручную через настройки браузера
- Для {{HTMLElement("iframe")}} и его документа явно разрешён autoplay через [Permissions Policy](/ru/docs/Web/HTTP/Guides/Permissions_Policy)

В противном случае воспроизведение, скорее всего, будет заблокировано.
Точные условия блокировки и способы попадания в белый список зависят от конкретного браузера, но приведённые выше пункты служат хорошей общей рекомендацией.

Для подробностей см. политики автозапуска для [Google Chrome](https://developer.chrome.com/blog/autoplay/) и [WebKit](https://webkit.org/blog/7734/auto-play-policy-changes-for-macos/).

> [!NOTE]
> Проще говоря, воспроизведение любого медиа с аудио обычно блокируется, если оно инициировано программно в вкладке без предварительного взаимодействия пользователя. Браузеры могут вводить дополнительные ограничения в других ситуациях.

## Автозапуск медиа-элементов

Теперь, когда мы рассмотрели, что такое автозапуск и что может его блокировать, давайте посмотрим, как на сайте или в приложении автоматически воспроизводить медиа при загрузке страницы, как определить неудачу автозапуска и что делать, если браузер отказал в автозапуске.

### Атрибут autoplay

Самый простой способ автоматически запустить контент — добавить атрибут [`autoplay`](/ru/docs/Web/HTML/Reference/Elements/audio#autoplay) к элементу {{HTMLElement("audio")}} или {{HTMLElement("video")}}, что устанавливает свойство {{domxref("HTMLMediaElement.autoplay", "autoplay")}} в значение `true`.
Когда `autoplay` установлен, медиа начинает воспроизводиться сразу после выполнения следующих условий:

- Страница имеет право на автозапуск
- Элемент создан в процессе загрузки страницы
- Получено достаточно данных для начала воспроизведения и дальнейшего воспроизведения до конца без перебоев (при условии, что сеть остаётся стабильной)

#### Пример: Атрибут autoplay

Элемент {{HTMLElement("audio")}} с атрибутом `autoplay` может выглядеть следующим образом:

```html
<audio id="musicplayer" autoplay>
  <source src="/music/chapter1.mp3" />
</audio>
```

#### Пример 2: Определение возможности автозапуска

Если для вашего приложения важно, будет ли автозапуск разрешён, можно адаптировать поведение в зависимости от результата.
Например, если известно, что страница разрешает лишь беззвучный автозапуск, вы можете отключить звук или предоставить видео без аудио-дорожки. Если автозапуск полностью запрещён, можно показать статичное изображение ([`poster`](/ru/docs/Web/HTML/Reference/Elements/video#poster)), или отложить загрузку видео до явного запроса пользователя.

Метод [`Navigator.getAutoplayPolicy()`](/ru/docs/Web/API/Navigator/getAutoplayPolicy) позволяет проверить политику автозапуска для типов медиа (всех медиа-элементов или аудио-контекстов) или для конкретного элемента/контекста.

Приведённый ниже пример показывает, как передать строку `mediaelement` для получения политики автозапуска для всех медиа-элементов в документе (если передать `audiocontext` будет получена политика для аудио-контекстов).
В коде предполагается, что переменная `video` — это объект `HTMLVideoElement`, созданный с помощью тега [`<video>`](/ru/docs/Web/HTML/Reference/Elements/video#autoplay) или класса[`HTMLVideoElement`](/ru/docs/Web/API/HTMLVideoElement), и по умолчанию настроенный на автозапуск с включённым звуком.
Если автозапуск разрешён только для беззвучного контента, мы отключаем звук у видео; если автозапуск запрещён, устанавливаем для видео изображение-заглушку.

```js
if (navigator.getAutoplayPolicy("mediaelement") === "allowed") {
  // Видео с аудио запустится автоматически.
} else if (navigator.getAutoplayPolicy("mediaelement") === "allowed-muted") {
  // Выключить аудио на видео
  video.muted = true;
} else if (navigator.getAutoplayPolicy("mediaelement") === "disallowed") {
  // Устанавливаем изображение-заглушку
  video.poster = "http://example.com/poster_image_url";
}
```

Аналогичным образом проверяется политика автозапуска для конкретного элемента или аудио-контекста: вместо передачи строкового значения типа можно передать сам объект или контекст. В приведённом ниже примере мы передаём объект `video`, который нужно проверить.

```js
if (navigator.getAutoplayPolicy(video) === "allowed") {
  // Автозапуск с аудио разрешён.
} else if (navigator.getAutoplayPolicy(video) === "allowed-muted") {
  // Отключаем звук видео
  video.muted = true;
} else if (navigator.getAutoplayPolicy(video) === "disallowed") {
  // Устанавливаем изображение-заглушку
  video.poster = "http://example.com/poster_image_url";
}
```

Политика автозапуска может изменяться после взаимодействия пользователя, а в некоторых браузерах локальная политика для конкретного элемента может измениться независимо от общей настройки.

Поскольку нет способа получить уведомление об изменении политики автозапуска (ни для типа медиа, ни для конкретного элемента), мы рекомендуем проверять эту политику при загрузке страницы, используя тип медиа.

#### Пример 3: Как определить, что автозапуск не сработал

Никакого специального события (или другого уведомления) о том, что автозапуск сработал или не сработал, не возникает, поэтому в браузерах, которые не поддерживают [`Navigator.getAutoplayPolicy()`](/ru/docs/Web/API/Navigator/getAutoplayPolicy), нет простого способа определить, разрешён ли автозапуск, и отреагировать на его успешное или неуспешное выполнение.

Один из способов — отслеживать первый случай срабатывания события {{domxref("HTMLMediaElement/play_event", "play")}} на медиа-элементе, которое генерируется как при возобновлении воспроизведения после паузы, _так и_ при срабатывании автозапуска. Это означает, что при первом срабатывании события `play` вы можете быть уверены, что ваше медиа начало воспроизводиться сразу после загрузки страницы.

Рассмотрим следующий HTML-код медиа-элемента:

```html
<video src="my-video.mp4" id="video" autoplay></video>
```

Здесь у нас есть элемент {{HTMLElement("video")}} с атрибутом [`autoplay`](/ru/docs/Web/HTML/Reference/Elements/video#autoplay) и навешенным на него обработчиком события {{domxref("HTMLMediaElement.play_event", "play")}}, которое обрабатывается функцией `handleFirstPlay()`, принимающей в качестве аргумента объект события.

`handleFirstPlay()` выглядит так:

```js
const video = document.getElementById("video");
video.addEventListener("play", handleFirstPlay, false);

let hasPlayed = false;
function handleFirstPlay(event) {
  if (!hasPlayed) {
    hasPlayed = true;

    // Удаляем listener, чтобы этот код выполнился только один раз.
    const vid = event.target;
    vid.removeEventListener("play", handleFirstPlay);

    // Запускаем любую логику, зависящую от того, что воспроизведение началось.
  }
}
```

После получения ссылки на видео через свойство {{domxref("Event")}} object's {{domxref("Event.target", "target")}}, мы удаляем listener, чтобы последующие события `play` (например, когда пользователь ставит видео на паузу и возобновляет, или когда браузер автоматически возобновляет воспроизведение в фоне) больше не вызывали этот обработчик.

Теперь ваш сайт или приложение может запускать любую логику, которая зависит от того, что видео действительно начало воспроизводиться.

### Метод play()

Термин «автозапуск» также относится к сценариям, когда код пытается начать воспроизведение медиа с аудио вне контекста обработки пользовательского события, вызывая метод {{domxref("HTMLMediaElement.play", "play()")}} медиа-элемента.

> [!NOTE]
> Рекомендуется по возможности использовать атрибут `autoplay`, поскольку поддержка настроек автозапуска через HTML-атрибуты более распространена, чем через скрипты. Это также позволяет браузеру оптимизировать момент старта.

#### Пример: воспроизведение видео через скрипт

Метод `play()` не запустит воспроизведение, если документу не разрешён автозапуск.

```js
document.querySelector("video").play();
```

#### Пример: обработка ошибок play()

Гораздо проще отследить неудачный автозапуск, если вы сами вызываете{{domxref("HTMLMediaElement.play", "play()")}}. Этот метод возвращает {{jsxref("Promise")}}, который разрешается (resolved) при успешном начале воспроизведения и отклоняется (rejected), если воспроизвести медиа не удалось (например, из-за запрета автозапуска)

В случае неудачи имеет смысл показать пользователю элемент управления, позволяющий вручную запустить воспроизведение:

```js
let startPlayPromise = videoElem.play();

if (startPlayPromise !== undefined) {
  startPlayPromise
    .then(() => {
      // Логика после успешного старта воспроизведения.
    })
    .catch((error) => {
      if (error.name === "NotAllowedError") {
        showPlayButton(videoElem);
      } else {
        // Обработка других ошибок загрузки или воспроизведения.
      }
    });
}
```

Мы проверяем, что `play()` вернул не `undefined`, поскольку в более старых спецификациях метод не возвращал значение. `play()`. Возврат Promise для определения успеха или неудачи операции был добавлен сравнительно недавно. Проверка на `undefined` предотвращает сбой этого кода с ошибкой в более старых версиях веб-браузеров.

Если Promise, возвращённый`play()`, разрешается без ошибок, выполняется блок `then()`, в котором можно запускать все необходимые действия после начала автозапуска.

Далее мы добавляем обработчик {{jsxref("Promise.catch", "catch()")}} к этому Promise. Он проверяет свойство {{domxref("DOMException.name", "name")}} у ошибки, чтобы узнать, равно ли оно `NotAllowedError`. Это означает, что воспроизведение не удалось из-за проблем с разрешениями, например когда автозапуск запрещён. В таком случае следует показать интерфейс для ручного запуска воспроизведения — здесь это делает функция `showPlayButton()`.

Любые другие ошибки обрабатываются по необходимости.

Если вы хотите начать воспроизведение видео после первого взаимодействия пользователя со страницей, можно использовать, {{domxref("Window.setInterval", "setInterval()")}} для периодических попыток:

```js
let playAttempt = setInterval(() => {
  videoElem
    .play()
    .then(() => {
      clearInterval(playAttempt);
    })
    .catch((error) => {
      console.log("Unable to play the video, User has not interacted yet.");
    });
}, 3000);
```

## Автозапуск с помощью Web Audio API

В [Web Audio API](/ru/docs/Web/API/Web_Audio_API) сайт или приложение может начать воспроизведение аудио, вызвав метод `start()` у узла-источника, привязанного к {{domxref("AudioContext")}}. Если это делается вне контекста обработки события пользовательского ввода, на него распространяются правила автозапуска.

## Политика разрешений для автозапуска

Помимо управления автозапуском на стороне браузера, веб-сервер также может выразить своё согласие на работу автозапуска. Для этого используется директива {{httpheader("Permissions-Policy/autoplay", "autoplay")}} заголовка{{HTTPHeader("Permissions-Policy")}} из {{Glossary("HTTP")}}. По умолчанию политика `autoplay` установлена в `self`, что означает, что автозапуск разрешён только для ресурсов с того же домена, что и документ.

Можно также указать пустой список разрешённых источников (`()`) полностью отключить автозапуск, `*` — чтобы разрешить автозапуск со всех доменов, или перечислить конкретные домен через пробел.

> [!NOTE]
> Указанная политика Permissions Policy применяется к документу и всем вложенным в него {{HTMLElement("iframe")}} если только для этих фреймов не задан собственный атрибут [`allow`](/ru/docs/Web/HTML/Reference/Elements/iframe#allow), который устанавливает новую политику для этого фрейма и всех его потомков.

При использовании атрибута [`allow`](/ru/docs/Web/HTML/Reference/Elements/iframe#allow) у `<iframe>` для задания политики разрешений можно указать значение `'src'`, чтобы разрешить автозапуск медиа только с того же домена, что указан в атрибуте [`src`](/ru/docs/Web/HTML/Reference/Elements/iframe#src).

### Пример: Разрешить автозапуск только с домена документа

Чтобы использовать заголовок {{HTTPHeader("Permissions-Policy")}} для разрешения автозапуска медиа только с {{Glossary("origin")}} (домен) документа:

```http
Permissions-Policy: autoplay=(self)
```

Аналогично через {{HTMLElement("iframe")}}:

```html
<iframe src="mediaplayer.html" allow="autoplay"> </iframe>
```

### Пример: Разрешить автозапуск с конкретных источников

Добавление разрешения для [Fullscreen API](/ru/docs/Web/API/Fullscreen_API) к предыдущему примеру приводит к появлению заголовка `Permissions-Policy` следующего вида, если доступ к полноэкранному режиму разрешён независимо от домена; при необходимости можно добавить ограничение по домену.

```http
Permissions-Policy: autoplay=(self), fullscreen=(self)
```

Те же самые разрешения, заданные через свойство `allow` элемента `<iframe>`, выглядят следующим образом:

```html
<iframe src="mediaplayer.html" allow="autoplay; fullscreen"> </iframe>
```

### Разрешить автозапуск с конкретных источников

Заголовок `Permissions-Policy`, разрешающий воспроизведение медиа как с домена документа (или `<iframe>`), так и с `https://example.media`, выглядит следующим образом:

```http
Permissions-Policy: autoplay=(self "https://example.media")
```

Элемент {{HTMLElement("iframe")}} можно прописать так, чтобы эта политика автозапуска применялась к самому фрейму и всем вложенным в него фреймам:

```html
<iframe
  width="300"
  height="200"
  src="mediaplayer.html"
  allow="autoplay 'src' https://example.media">
</iframe>
```

### Отключить автозапуск

Установка политики `autoplay` в `()` либо `none` полностью отключает автозапуск для документа или `<iframe>` и всех вложенных фреймов. HTTP-заголовок будет таким:

```http
Permissions-Policy: autoplay=()
```

Используя атрибут `allow` элемента `<iframe>`:

```html
<iframe src="mediaplayer.html" allow="autoplay 'none'"> </iframe>
```

## Рекомендации

Здесь приведены советы и рекомендованные методы, которые помогут вам максимально эффективно использовать автозапуск.

### Обработка неудачного автозапуска с помощью элементов управления медиа

Распространённый сценарий автозапуска — автоматически начать воспроизведение видеоклипа, сопровождающего статью, рекламный ролик или превью основной функциональности страницы. Чтобы автозапустить подобные видео, у вас есть два варианта: убрать звуковую дорожку или оставить её, но настроить элемент {{HTMLElement("video")}} так, чтобы звук был отключён по умолчанию, например:

```html
<video
  src="/videos/awesomevid.webm"
  controls
  autoplay
  playsinline
  muted></video>
```

Этот элемент video настроен на отображение пользовательских элементов управления (обычно воспроизведение/пауза, перемотка по временной шкале, регулировка громкости и выключение звука); кроме того, поскольку указан атрибут [`muted`](/ru/docs/Web/HTML/Reference/Elements/video) и атрибут [`playsinline`](/ru/docs/Web/HTML/Reference/Elements/video), необходимый для автозапуска в Safari, видео будет воспроизводиться автоматически и без звука. Пользователь, однако, может включить звук, нажав кнопку «включить звук» в элементах управления.

## Параметры автозапуска в браузерах

В браузерах могут быть настройки (preferences), которые управляют поведением автозапуска медиа или блокировкой автозапуска. Здесь перечислены те из них, которые могут быть особенно важны для веб-разработчика: как для тестирования и отладки, так и те, которые могут быть настроены пользователем, и на которые вам нужно быть готовым реагировать.

### Firefox

- `media.allowed-to-play.enabled`
  - : Логическая (Boolean) настройка, которая определяет, будет ли веб-разработчикам доступно нестандартное свойство `HTMLMediaElement.allowedToPlay`. По умолчанию стоит `false` (в nightly-сборках — `true`). Если значение`false`, то свойство`allowedToPlay` отсутствует в интерфейсе, и, соответственно, не появляется ни у элементов {{HTMLElement("audio")}} или {{HTMLElement("video")}}.
- `media.autoplay.allow-extension-background-pages`
  - : Логическая настройка, которая при значении `true` позволяет фоновым скриптам расширений автоматически запускать аудиоплееры. Если установить в `false` то расширения не смогут включать аудио в фоне. По умолчанию — `true`.
- `media.autoplay.allow-muted`
  - : Логическая настройка, которая при значении `true` (по умолчанию) позволяет автоматически воспроизводить медиа, у которых отключён звук (muted). Если поменять на `false`, то даже при выключенном звуке воспроизведение с аудиодорожкой заблокируется.
- `media.autoplay.block-webaudio`
  - : Логическая настройка, отвечающая за применение политики блокировки автозапуска к [Web Audio API](/ru/docs/Web/API/Web_Audio_API).
    При `false` Web Audio API всегда может автоматически воспроизводить звук.
    При `true`, аудио-контексты смогут начать воспроизведение только после пользовательского взаимодействия со страницей (так называемой «липкой активации») {{Glossary("Sticky activation")}}.
    По умолчанию стоит `true`.
- `media.autoplay.default`
  - : Целочисленная настройка, определяющая поведение автозапуска по умолчанию для каждого домена: разрешён (autoplay allowed) (`0`), заблокирован (autoplay blocked) (`1`), спрашивать при попытке воспроизведения (prompt-on-use) (`2`). По умолчанию — `0`.
- `media.autoplay.enabled.user-gestures-needed` (только для nightly)
  - : Логическая настройка, позволяющая учесть пользовательские действия для переопределения `media.autoplay.default`. Если `media.autoplay.default` _не_ равен `0` при `true` эта опция даст возможность воспроизводить аудио-дорожки после любого пользовательского взаимодействия со страницей; невоспроизводимый звук (тихо или отключён) и так не ограничивается.
- `media.block-autoplay-until-in-foreground`
  - : Логическая настройка, которая при значении `true` (по умолчанию) блокирует воспроизведение в фоновой вкладке до тех пор, пока пользователь не вернётся в эту вкладку. Это предотвращает неожиданное воспроизведение звука в невидимой вкладке.

## Полезные ссылки

- [Технологии веб-медиа](/ru/docs/Web/Media)
- [HTML видео и аудио](/ru/docs/Learn_web_development/Core/Structuring_content/HTML_video_and_audio) (Учебное руководство)
- [Использование Web Audio API](/ru/docs/Learn_web_development/Core/Structuring_content/HTML_video_and_audio)
- [Базовые принципы аудио в разных браузерах](/ru/docs/Web/Media/Guides/Audio_and_video_delivery/Cross-browser_audio_basics)
