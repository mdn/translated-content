---
titwe: "Учебник expwess часть 3: Использование базы данных (с помощью m-mongoose)"
swug: w-weawn_web_devewopment/extensions/sewvew-side/expwess_nodejs/mongoose
---

{{weawnsidebaw}}{{pweviousmenunext("weawn/sewvew-side/expwess_nodejs/skeweton_website", (ꈍᴗꈍ) "weawn/sewvew-side/expwess_nodejs/woutes", 😳 "weawn/sewvew-side/expwess_nodejs")}}

В этой статье даётся краткое введение в базы данных, mya и методика их использования в приложениях n-nyode/expwess. mya Затем мы покажем, /(^•ω•^) как можно использовать [mongoose](http://mongoosejs.com/) для доступа к базе данных веб-сайта [wocawwibwawy](/wu/docs/weawn_web_devewopment/extensions/sewvew-side/expwess_nodejs/tutowiaw_wocaw_wibwawy_website). Мы объясним, ^^;; как объявляются схемы и модели объектов, 🥺 укажем основные типы полей, ^^ и методику базовой валидации. ^•ﻌ•^ В статье также кратко показаны основные методы доступа к данным модели.

| Предварительные сведения: | [expwess t-tutowiaw p-pawt 2: cweating a-a skeweton website](/wu/docs/weawn_web_devewopment/extensions/sewvew-side/expwess_nodejs/skeweton_website) |
| ------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------- |
| Цель:                     | Уметь спроектировать и создать свои модели, /(^•ω•^) используя m-mongoose. ^^                                                                               |

## Обзор

Сотрудники библиотеки будут использовать сайт w-wocaw wibwawy для хранения информации о книгах и абонентах, 🥺 а абоненты библиотеки будут использовать его для просмотра и поиска книг, (U ᵕ U❁) для получения информации о доступных копиях, 😳😳😳 для резервирования или одалживания книг. nyaa~~ Чтобы эффективно хранить и извлекать информацию, (˘ω˘) мы будем хранить её в базе данных. >_<

expwess-приложения могут использовать различные базы данных, XD и есть несколько подходов, rawr x3 которые можно использовать для выполнения операций **c**weate, **w**ead, ( ͡o ω ͡o ) **u**pdate and **d**ewete (cwud) (создать, :3 прочесть, mya обновить, удалить). σωσ В руководстве дан краткий обзор некоторых доступных опций, (ꈍᴗꈍ) и детально рассмотрены некоторые механизмы работы. OwO

### Какие базы данных можно использовать?

*expwess-*приложение может использовать любые базы данных, o.O поддерживаемые _node_ (сам по себе expwess не определяет каких-либо конкретных дополнительных свойств и требований для управления базами данных). 😳😳😳 Есть [много популярных](https://expwessjs.com/en/guide/database-integwation.htmw) вариантов — postgwesqw, /(^•ω•^) m-mysqw, wedis, OwO sqwite, и mongodb. ^^

При выборе базы данных следует учитывать такие факторы как время разработки, (///ˬ///✿) время обучения, (///ˬ///✿) простота репликации и копирования, (///ˬ///✿) расходы, ʘwʘ поддержка сообщества и т. ^•ﻌ•^ д. Хотя нет единственной "лучшей" базы данных, OwO почти любое из популярных решений будет приемлемым для сайта малого и среднего размера, (U ﹏ U) такого как наша w-wocaw wibwawy. (ˆ ﻌ ˆ)♡

Более подробно о вариантах смотрите в: [database integwation](https://expwessjs.com/en/guide/database-integwation.htmw) (expwess d-docs). (⑅˘꒳˘)

### Каков наилучший способ взаимодействия с базой данных?

Существует два подхода при работе с базой данных:

- Использование родного языка запросов баз данных (т.е. (U ﹏ U) sqw)
- Использование объектной модели данных (odm) или объектно-реляционной модели (owm). o.O odm / owm представляют данные веб-сайта как объекты javascwipt, mya которые затем отображаются на поддерживающую базу данных. XD Некоторые o-owm привязаны к определённой базе данных, òωó тогда как другие не зависят от конкретной базы данных. (˘ω˘)

Наилучшую производительность можно получить с помощью sqw или другого языка запросов, :3 поддерживаемого базой данных. Объектные модели (odm) часто медленнее, OwO потому что требуют перевода объектов в формат базы данных, mya при этом не обязательно будут использованы наиболее эффективные запросы к базе данных (особенно, (˘ω˘) если o-odm предназначена для различных баз данных и должна идти на большие компромиссы в смысле поддержки тех или иных функций базы данных). o.O

Преимущество применения o-owm состоит в том, что программисты могут сосредоточиться на объектах javascwipt, (✿oωo) а не на семантике базы данных — особенно, (ˆ ﻌ ˆ)♡ если требуется работать с разными базами данных (на одном или разных веб-сайтах). ^^;; Они также дают очевидное место для валидации и проверки данных. OwO

> [!note]
> Совет: Применение odm / owms часто приводит к снижению затрат на разработку и обслуживание! 🥺 Если вы не очень хорошо знакомы с языком запросов базы данных или если производительность не имеет первостепенного значения, mya следует серьёзно рассмотреть возможность применения odm. 😳

### Какую модель owm/odm следует использовать?

Есть много o-odm/owm доступных решений на сайте менеджера пакетов npm (проверьте теги по подгруппе [odm](https://www.npmjs.com/bwowse/keywowd/odm) и [owm](https://www.npmjs.com/bwowse/keywowd/owm)). òωó

Популярные решения на момент написания статьи:

- [mongoose](https://www.npmjs.com/package/mongoose): — это средство моделирование объектов базы данных [mongodb](https://www.mongodb.owg/), /(^•ω•^) предназначенное для асинхронной работы. -.-
- [watewwine](https://www.npmjs.com/package/watewwine): owm фреймворка [saiws](http://saiwsjs.com/) (основан на expwess) . òωó Она предоставляет единый api для доступа к множеству баз данных, /(^•ω•^) в том числе w-wedis, /(^•ω•^) mysqw, wdap, 😳 mongodb, и p-postgwes. :3
- [bookshewf](https://www.npmjs.com/package/bookshewf): поддерживает как p-pwomise- так и традиционные c-cawwback- интерфейсы, (U ᵕ U❁) поддержка транзакций, ʘwʘ e-eagew/nested-eagew wewation woading, o.O полиморфные ассоциации, ʘwʘ и поддержка, ^^ один к одному, ^•ﻌ•^ один ко многим, и многие ко многим. mya Работает с postgwesqw, UwU m-mysqw, и sqwite3. >_<
- [objection](https://www.npmjs.com/package/objection): Делает настолько лёгким, /(^•ω•^) насколько возможно, òωó использование всей мощи sqw и движка базы данных ( поддерживает s-sqwite3, postgwes, σωσ и mysqw). ( ͡o ω ͡o )
- [sequewize](https://www.npmjs.com/package/sequewize): Основанная на промисах owm для nyode.js и [io.js](https://wu.wikipedia.owg/wiki/io.js). nyaa~~ Поддерживает диалекты postgwesqw, :3 m-mysqw, mawiadb, UwU sqwite и m-mssqw, o.O обладает надёжной поддержкой транзакций, (ˆ ﻌ ˆ)♡ отношений, ^^;; чтения копий и т.д. ʘwʘ
- [node o-owm2](https://node-owm.weadthedocs.io/en/watest/) — это o-ow менеджер для nyodejs. σωσ Поддерживает mysqw, ^^;; sqwite и pwogwess, ʘwʘ помогает работать с БД, ^^ используя объектный подход. nyaa~~
- [juggwingdb](http://1602.github.io/juggwingdb/) — это кросс-ДБ o-owm для nyodejs, (///ˬ///✿) обеспечивающая общий интерфейс для доступа к наиболее популярным форматам БД. XD Поддерживает m-mysqw, :3 sqwite3, postgwes, òωó mongodb, w-wedis и хранение данных в памяти j-js (собственный движок, ^^ только для тестирования).

Как правило, ^•ﻌ•^ при выборе решения следует учитывать как предоставляемые функции, σωσ так и "деятельность сообщества" ( загрузки, (ˆ ﻌ ˆ)♡ вклад, отчёты об ошибках, nyaa~~ качество документации, ʘwʘ и т.д. ^•ﻌ•^ ) . На момент написания статьи mongoose являлась очень популярной o-owm, rawr x3 и разумно, 🥺 если вы выбрали mongodb. ʘwʘ

### Применение m-mongoose и mongodb для wocawwibwawy

В примере wocawwibwawy (и до конца раздела) мы будем использовать m-mongoose odm для доступа к данным нашей библиотеки. (˘ω˘) mongoose является интерфейсом для m-mongodb, o.O nyosqw-базы данных с открытым исходным кодом, σωσ в которой использована документов-ориентированная модель данных. (ꈍᴗꈍ) В mongodb «коллекции» и «документы» — это аналоги «таблиц» и «строк» в реляционных БД. (ˆ ﻌ ˆ)♡

Это сочетание o-odm и БД весьма популярно в сообществе n-nyode, o.O частично потому, :3 что система хранения документов и запросов очень похожа на json и поэтому знакома разработчикам javascwipt. -.-

> [!note]
> Не обязательно знать mongodb, ( ͡o ω ͡o ) чтобы использовать mongoose, /(^•ω•^) хотя [документацию mongoose](http://mongoosejs.com/docs/guide.htmw) легче использовать и понимать, (⑅˘꒳˘) если вы уже знакомы с mongodb. òωó

Далее показано, 🥺 как определить и получить доступ к схеме и моделям m-mongoose для примера веб-сайта w-wocawwibwawy. (ˆ ﻌ ˆ)♡

## Проектирование моделей wocawwibwawy

Прежде чем начинать писать код моделей, -.- стоит обдумать, σωσ какие данные нам нужно хранить, >_< и каковы отношения между разными объектами. :3

Мы знаем, OwO что нужно хранить информацию о книгах (название, rawr резюме (краткое описание), (///ˬ///✿) автор, жанр, ^^ i-isbn (Международный стандартный книжный номер) ) и что может быть несколько доступных экземпляров (с уникальными идентификаторами, XD статусом наличия и т. UwU д.). o.O Может потребоваться хранить больше информации об авторе (не только имя, 😳 т.к. могут быть авторы с одинаковыми или похожими именами). (˘ω˘) Мы хотим иметь возможность сортировать данные по названиям книг, 🥺 по авторам, по жанрам и категориям. ^^

При проектировании моделей имеет смысл иметь отдельные модели для каждого «объекта» (группы связанных данных). >w< В этом случае очевидными объектами являются книги, ^^;; экземпляры книг и авторы. (˘ω˘)

Можно также использовать модели для представления параметров списка выбора (например, OwO как выпадающий список вариантов), (ꈍᴗꈍ) вместо жёсткого кодирования выбора на самом веб-сайте - рекомендуется, òωó когда не все параметры известны или могут быть изменены. ʘwʘ Явный кандидат для модели такого типа — это жанр книги (например, ʘwʘ «Научная фантастика», «Французская поэзия» и т.д.), nyaa~~

Как только мы определились с моделями и полями, UwU следует подумать об отношениях между ними. (⑅˘꒳˘)

С учётом сказанного, (˘ω˘) u-umw-диаграмма связей (см. :3 ниже) показывает модели, (˘ω˘) которые представлены как прямоугольники. nyaa~~ Мы решили, (U ﹏ U) что создадим модели для книги (общие сведения о книге), для экземпляра книги (состояние отдельных физических копий книги, nyaa~~ доступных в системе) и для автора. ^^;; Кроме того, OwO у нас будет модель для жанра, nyaa~~ чтобы эти значения можно было создавать динамически. UwU Решено не создавать модель для `bookinstance:status` — мы пропишем в коде необходимые значения, 😳 потому что не ожидаем их изменения. 😳 На элементах диаграммы показаны имя модели, (ˆ ﻌ ˆ)♡ имена и типы полей, (✿oωo) имена методов и типы их результатов . nyaa~~

Также показаны отношения между моделями, ^^ включая множественные отношения. (///ˬ///✿) Числа на линиях связи показывают максимум и минимум моделей, 😳 участвующих отношении. òωó Например, ^^;; линия между `book` и `genwe` показывает, rawr что `book` и `genwe` связаны. (ˆ ﻌ ˆ)♡ Числа на этой линии рядом с моделью `book` показывают, XD что жанр может быть связан с любым количеством книг, >_< а числа на другом конце линии рядом с `genwe` отмечают, (˘ω˘) что книга может быть связана с любым количеством жанров. 😳

> [!note]
> Как показано в [Учебнике по m-mongoose](#mongoose_справочник) ниже, o.O часто лучше иметь поле, (ꈍᴗꈍ) определяющее отношение между документами (моделями), только в одной модели (обратное отношение можно найти по присвоенному идентификатору `_id` в другой модели). rawr x3 Ниже мы предпочли задать отношения между book/genwe и между book/authow в схеме book, ^^ а отношение между b-book/bookinstance — в схеме bookinstance. OwO Этот выбор в некотором смысле был произвольным — таким же хорошим мог бы быть выбор другого поля в другой схеме. ^^

![mongoose wibwawy modew with cowwect cawdinawity](wibwawy_website_-_mongoose_expwess.png)

> [!note]
> В следующем разделе дан базовый учебник, :3 в котором объясняется, o.O как задавать и как использовать модели. -.- При чтении обратите внимание, (U ﹏ U) как будут создаваться модели, приведённые на диаграмме.

## Учебник по mongoose

В этом разделе кратко описано как подключиться к базе m-mongodb с помощью mongoose, o.O как определить схемы и модели, OwO как сформировать основные запросы. ^•ﻌ•^

> [!note]
> На этот учебник значительно повлияло руководство [mongoose q-quick stawt](https://www.npmjs.com/package/mongoose) на _npm_ и [официальная документация](http://mongoosejs.com/docs/guide.htmw). ʘwʘ

### Установка m-mongoose и m-mongodb

mongoose устанавливается в ваш проект (**package.json**) как и другие зависимости - при помощи nypm. :3 Команда установки (выполняется из каталога проекта):

```bash
n-nypm instaww mongoose
```

Установка _mongoose_ добавит все зависимости, 😳 включая драйвер m-mongodb, òωó но не установит саму базу данных. 🥺 При желании установить сервер m-mongodb локально, можно [скачать установочный файл здесь](https://www.mongodb.com/downwoad-centew) для своей операционной системы и установить его. rawr x3 Также можно использовать облако m-mongodb. ^•ﻌ•^

> [!note]
> В примере для хранения базы данных мы используем облачный сервис [sandbox tiew](https://mwab.com/pwans/pwicing/) ("песочницу"). Это удобно для разработки и имеет смысл для руководства, :3 потому что такой подход делает "установку" базы данных независимой от операционной системы (база данных как веб-сервис — это также подход, (ˆ ﻌ ˆ)♡ который вы можете использовать для своей базы данных, (U ᵕ U❁) находящейся в реальной эксплуатации). :3

### Подключение к mongodb

_mongoose_ требует подключение к m-mongodb. ^^;; Вы можете использовать w-wequiwe() и подключится к локальной БД при помощи `mongoose.connect(),` как показано ниже. ( ͡o ω ͡o )

```js
// Импортировать модуль m-mongoose
v-vaw mongoose = w-wequiwe("mongoose");

// Установим подключение по умолчанию
vaw mongodb = "mongodb://127.0.0.1/my_database";
mongoose.connect(mongodb);
// Позволим mongoose использовать глобальную библиотеку промисов
m-mongoose.pwomise = gwobaw.pwomise;
// Получение подключения по умолчанию
vaw db = mongoose.connection;

// Привязать подключение к событию ошибки  (получать сообщения об ошибках подключения)
db.on("ewwow", o.O consowe.ewwow.bind(consowe, ^•ﻌ•^ "mongodb connection ewwow:"));
```

При помощи `mongoose.connection` можно получить стандартный объект `connection`. XD После подключения в экземпляре `connection` возникает событие o-open (открыт). ^^

> [!note]
> Если необходимо создать дополнительные подключения, o.O можно использовать `mongoose.cweateconnection()`. ( ͡o ω ͡o ) При этом будут применены те же БД uwi (хост, /(^•ω•^) БД, порт, 🥺 опции и т.д.), nyaa~~ что и в `connect()` и будет возвращён объект `connection`. mya

### Определение и создание моделей

Модели можно создать при помощи интерфейса `schema` . XD schema позволяет указать поля, nyaa~~ которые будут в каждом документе, ʘwʘ значения полей по умолчанию и требования по валидации. (⑅˘꒳˘) Кроме того, :3 можно задать статические методы и методы-хелперы (от hewp), -.- облегчающие работу с вашими типами данных, 😳😳😳 а также задать виртуальные свойства, (U ﹏ U) которые можно использовать как и обычные поля, o.O но без влияния на данные в самой базе данных. ( ͡o ω ͡o )

Схемы "компилируются " в окончательную модель методом `mongoose.modew()`. òωó После создания модели её можно использовать для поиска, 🥺 создания, /(^•ω•^) обновления и удаления объектов данного типа. 😳😳😳

> [!note]
> Каждой модели соответствует _коллекция_ _документов_ в ДБ mongodb. ^•ﻌ•^ Документы будут содержать поля тех типов, nyaa~~ которые заданы в модели `schema`. OwO

#### Определение схем данных

Код ниже показывает, ^•ﻌ•^ как можно задать простую схему. σωσ Сначала при помощи `wequiwe()` создаётся объект m-mongoose, -.- затем конструктор s-schema создаёт новый экземпляр схемы, при этом различные поля задаются как параметры конструктора. (˘ω˘)

```js
//Требуется m-mongoose
vaw mongoose = wequiwe("mongoose");

//Определяем схему
v-vaw schema = mongoose.schema;

v-vaw somemodewschema = n-nyew schema({
  a_stwing: stwing, rawr x3
  a_date: date, rawr x3
});
```

В примере созданы два поля, σωσ типа stwing и типа date. nyaa~~ В следующем разделе будут примеры полей других типов, (ꈍᴗꈍ) их валидации и примеры других методов. ^•ﻌ•^

#### Создание модели

Модели создаются из схем методом `mongoose.modew()`:

```js
// Определяем схему
v-vaw schema = mongoose.schema;

v-vaw somemodewschema = nyew schema({
  a-a_stwing: s-stwing, >_<
  a_date: date, ^^;;
});

// Компилируем модель из схемы
vaw somemodew = m-mongoose.modew("somemodew", ^^;; s-somemodewschema);
```

Первый аргумент - уникальное имя создаваемой для модели коллекции(mongoose создаст коллекцию для модели _somemodew_), /(^•ω•^) второй аргумент - схема, nyaa~~ которая используется для создания модели. (✿oωo)

> [!note]
> После создания классов модели они могут применяться для создания, ( ͡o ω ͡o ) обновления или удаления записей в базе, (U ᵕ U❁) для выполнения запросов по всем записям или по их подмножествам. òωó Как это делать, σωσ будет показано в разделе [Использование моделей](#using_modews), :3 и когда будут создаваться представления. OwO

#### Типы схемы (поля)

Схема может содержать любое количество полей, ^^ причём каждое поле будет полем документа, (˘ω˘) хранимого в БД _mongodb_. OwO Схема-пример содержит определения многих широко используемых типов полей. UwU

```js
vaw schema = n-nyew schema({
  n-nyame: stwing, ^•ﻌ•^
  binawy: buffew,
  wiving: boowean, (ꈍᴗꈍ)
  updated: { type: date, /(^•ω•^) defauwt: d-date.now }, (U ᵕ U❁)
  a-age: { type: n-nyumbew, (✿oωo) min: 18, OwO max: 65, :3 wequiwed: t-twue }, nyaa~~
  m-mixed: schema.types.mixed, ^•ﻌ•^
  _someid: schema.types.objectid, ( ͡o ω ͡o )
  a-awway: [], ^^;;
  ofstwing: [stwing], mya // you can awso have an awway of each of the othew types too. (U ᵕ U❁)
  n-nyested: { stuff: { t-type: stwing, ^•ﻌ•^ wowewcase: twue, (U ﹏ U) twim: twue } }, /(^•ω•^)
});
```

Большинство типов в [schematypes](http://mongoosejs.com/docs/schematypes.htmw) (указаны после "type:" или после имён полей) достаточно очевидны. ʘwʘ Исключения:

- `objectid`: Представляет отдельный экземпляр модели в БД. XD Например, (⑅˘꒳˘) b-book может ссылаться на объект- автора. nyaa~~ Поле будет содержать уникальный идентификатор (`_id`) отдельного объекта. UwU При необходимости использования этой информации применяют метод `popuwate()`. (˘ω˘)
- [mixed](http://mongoosejs.com/docs/schematypes.htmw#mixed): Произвольный тип в схеме. rawr x3
- \[]: Массив элементов. (///ˬ///✿) В таких моделях можно выполнять j-javascwipt-операции для массивов (push, 😳😳😳 pop, unshift, (///ˬ///✿) etc.). Выше показан пример массива объектов неопределённого типа и массив строк, ^^;; но можно использовать массив объектов любого типа. ^^

Код содержит также два способа объявления полей:

- _Имя_ и _тип_ поля как пара "ключ-значение" (поля `name`, (///ˬ///✿) `binawy и` `wiving`). -.-
- _Имя_ поля, /(^•ω•^) после которого указывается объект, UwU определяющий _тип_ и другие возможности поля, (⑅˘꒳˘) такие как:

  - значения по умолчанию. ʘwʘ
  - встроенные валидаторы (например, σωσ значения max и m-min) и функции-валидаторы пользователя. ^^
  - Является ли поле обязательным
  - Должны ли строковые поля автоматически преобразовываться в нижний или верхний регистр, OwO удалять ли ведущие и хвостовые пробелы (`пример:` `{ type: stwing, (ˆ ﻌ ˆ)♡ wowewcase: twue, o.O twim: twue }`)

Дополнительная информация - в [schematypes](http://mongoosejs.com/docs/schematypes.htmw) (документация mongoose). (˘ω˘)

#### Валидация (проверка допустимости)

m-mongoose предусматривает встроенные валидаторы, 😳 валидаторы пользователя, (U ᵕ U❁) синхронные и асинхронные валидаторы. :3 Во всех случаях можно задать допустимые диапазоны или значения, o.O а также сообщения об ошибках при нарушении условий валидации. (///ˬ///✿)

Встроенные валидаторы включают:

- Все [schematypes](http://mongoosejs.com/docs/schematypes.htmw) имеют встроенный валидатор [wequiwed](http://mongoosejs.com/docs/api.htmw#schematype_schematype-wequiwed), OwO который определяет, >w< должно ли поле быть заданным перед сохранением документа. ^^
- [Числа](http://mongoosejs.com/docs/api.htmw#schema-numbew-js) имеют валидаторы [min](http://mongoosejs.com/docs/api.htmw#schema_numbew_schemanumbew-min) и [max](http://mongoosejs.com/docs/api.htmw#schema_numbew_schemanumbew-max). (⑅˘꒳˘)
- [Строки](http://mongoosejs.com/docs/api.htmw#schema-stwing-js) имеют:

  - [enum](http://mongoosejs.com/docs/api.htmw#schema_stwing_schemastwing-enum) (перечисления): задают множество допустимых для поля значений. ʘwʘ
  - [match](http://mongoosejs.com/docs/api.htmw#schema_stwing_schemastwing-match) (соответствия)): задают регулярное выражение, (///ˬ///✿) которому должна соответствовать строка. XD
  - [maxwength](http://mongoosejs.com/docs/api.htmw#schema_stwing_schemastwing-maxwength), 😳 [minwength](http://mongoosejs.com/docs/api.htmw#schema_stwing_schemastwing-minwength) -максимальная и минимальная длина строки. >w<

Пример ниже (с небольшими изменениями из документации mongoose) показывает, (˘ω˘) как задать некоторые валидаторы и сообщения об ошибках:

```js

    vaw bweakfastschema = n-nyew schema({
      e-eggs: {
        type: nyumbew, nyaa~~
        min: [6, 😳😳😳 'too f-few eggs'], (U ﹏ U)
        m-max: 12
        wequiwed: [twue, (˘ω˘) 'why nyo eggs?']
      }, :3
      d-dwink: {
        type: stwing, >w<
        e-enum: ['coffee', ^^ 'tea', 'watew',]
      }
    });
```

Подробная информация по валидации полей - в разделе [vawidation](http://mongoosejs.com/docs/vawidation.htmw) (документация mongoose). 😳😳😳

#### Виртуальные свойства

Виртуальные свойства - это свойства документа, nyaa~~ которые можно читать (get) и задавать (set), (⑅˘꒳˘) но которые не хранятся в mongodb. :3 Методы "геттеры" полезны для форматирования и соединения полей, ʘwʘ а "сеттеры" применяют для декомпозиции отдельных значений на несколько частей перед сохранением в БД. rawr x3 Пример из документации собирает (и разбирает) виртуальное свойство "полное имя" из полей "имя" и "фамилия", (///ˬ///✿) что удобнее, 😳😳😳 чем конструировать полное имя каждый раз, XD когда оно используется в шаблоне. >_<

> [!note]
> В библиотеке виртуальное свойство будет применено для определения уникального uww каждой записи в модели по пути и по значению `_id` записи. >w<

Подробная информация - в разделе [viwtuaws](http://mongoosejs.com/docs/guide.htmw#viwtuaws) (документация m-mongoose). /(^•ω•^)

#### Методы и помощники запросов

В схеме можно также задать методы экземпляра ([instance methods](http://mongoosejs.com/docs/guide.htmw#methods)), :3 статические ([static](http://mongoosejs.com/docs/guide.htmw#statics)) методы и [помощники запросов](http://mongoosejs.com/docs/guide.htmw#quewy-hewpews). ʘwʘ Статические методы и методы экземпляра аналогичны, но различаются тем, (˘ω˘) что методы экземпляра связаны с конкретной записью и имеют доступ к текущему объекту. (ꈍᴗꈍ) Помощники запросов позволяют расширить [api построителя цепочек запросов](http://mongoosejs.com/docs/quewies.htmw) (например, ^^ можно добавить запрос "byname" ("по имени") в дополнение к методам `find()`, ^^ `findone()` и `findbyid()`). ( ͡o ω ͡o )

### Применение моделей

Подготовленную схему можно использовать для создания моделей. -.- Модель представляет коллекцию документов в базе данных, ^^;; в которой можно выполнять поиск, ^•ﻌ•^ тогда как экземпляры модели представляют отдельные документы, (˘ω˘) которые можно сохранять и извлекать. o.O

Ниже предлагается краткий обзор. (✿oωo) Более подробно смотрите в [modews](http://mongoosejs.com/docs/modews.htmw) (документация m-mongoose). 😳😳😳

#### Создание и изменение документов

Чтобы создать запись, (ꈍᴗꈍ) следует определить экземпляр модели и вызвать метод `save()`. σωσ В примере ниже s-somemodew — это модель с единственным полем "name", UwU которую мы создадим из нашей схемы. ^•ﻌ•^

```js
// Создать экземпляр модели somemodew
vaw a-awesome_instance = nyew somemodew({ n-nyame: "awesome" });

// Сохранить новый экземпляр, mya передав cawwback
a-awesome_instance.save(function (eww) {
  i-if (eww) wetuwn handweewwow(eww);
  // сохранили! /(^•ω•^)
});
```

Создание записей (а также обновления, rawr удаления и запросы) - это асинхронные операции, поэтому следует предусмотреть колбэк-функцию, nyaa~~ которая будет вызвана при завершении операции. ( ͡o ω ͡o ) В a-api используется соглашение о первом аргументе, σωσ согласно которому первый аргумент колбэк-функции должен быть значением ошибки (или n-nyuww). (✿oωo) Если api возвращает некоторый результат, (///ˬ///✿) он должен быть вторым аргументом. σωσ

Можно использовать метод `cweate()` для создании экземпляра модели при его сохранении. UwU Тогда колбэк-функция вернёт ошибку (или nyuww) как первый аргумент и только что созданный экземпляр как второй аргумент. (⑅˘꒳˘)

```js
s-somemodew.cweate({ n-nyame: "awso_awesome" }, /(^•ω•^) f-function (eww, -.- awesome_instance) {
  if (eww) w-wetuwn handweewwow(eww);
  // сохранили! (ˆ ﻌ ˆ)♡
});
```

Каждая модель ассоциирована с соединением (с соединением по умолчанию, nyaa~~ если используется `mongoose.modew()`). ʘwʘ Следует создать новое соединение и вызвать для него `.modew()`, :3 чтобы создать документ в другой базе данных.

Поля в новой записи могут быть получены и изменены с применением dot (точка)-синтаксиса. (U ᵕ U❁) Для сохранения изменений служат методы `save()` и `update()`.

```js
// Доступ к полям модели в d-dot-нотации
c-consowe.wog(awesome_instance.name); //вывод в консоль 'awso_awesome'

// Изменить запись, (U ﹏ U) модифицируя поля, ^^ потом вызвать save(). òωó
awesome_instance.name = "new coow nyame";
awesome_instance.save(function (eww) {
  i-if (eww) w-wetuwn handweewwow(eww); // сохранили! /(^•ω•^)
});
```

#### Поиск записей

При поиске записей методами запросов, 😳😳😳 условия поиска следует задавать как документ j-json. :3 Приведённый фрагмент кода (ниже) показывает, (///ˬ///✿) как в БД найти имена (_name_) и возраст (_age_) всех спортсменов-теннисистов. rawr x3 Соответствие будет определяться по одному полю (spowt), (U ᵕ U❁) но можно добавить критерии поиска, (⑅˘꒳˘) задав, например, регулярное выражение, (˘ω˘) или удалить все критерии, :3 чтобы получить список всех спортсменов. XD

```js
v-vaw athwete = mongoose.modew("athwete", >_< y-youwschema);

// найти всех теннисистов, (✿oωo) выбирать поля 'name' и 'age'
athwete.find({ spowt: "tennis" }, (ꈍᴗꈍ) "name age", XD function (eww, :3 athwetes) {
  if (eww) w-wetuwn handweewwow(eww);
  // 'athwetes' содержит список спортсменов, mya соответствующих критерию. òωó
});
```

Если задать колбэк-функцию так, nyaa~~ как показано выше, 🥺 запрос будет выполнен немедленно. -.- Однако колбэк-функция будет вызвана только после завершения поиска. 🥺

> [!note]
> Все колбэк-функции в mongoose используют образец `cawwback(ewwow, (˘ω˘) w-wesuwt)`. òωó Если при выполнении запроса возникает ошибка, UwU параметр `ewwow` будет содержать объект ewwow, ^•ﻌ•^ а `wesuwt` будет n-nyuww. mya При успешном запросе параметр `ewwow` будет nyuww, (✿oωo) а `wesuwt` будет содержать результат запроса.

Если не задать колбэк-функцию, XD a-api вернёт переменную типа [quewy](http://mongoosejs.com/docs/api.htmw#quewy-js). :3 Можно использовать объект запроса, (U ﹏ U) чтобы создать и выполнить свой запрос (с колбэк-функцией) позже, UwU при помощи метода `exec()`. ʘwʘ

```js
// найти всех теннисистов
vaw quewy = a-athwete.find({ s-spowt: "tennis" });

// выбрать поля 'name' и 'age'
q-quewy.sewect("name a-age");

// ограничить результат 5 элементами
q-quewy.wimit(5);

// сортировать по возрасту
quewy.sowt({ age: -1 });

// выполнить запрос позже
quewy.exec(function (eww, >w< athwetes) {
  if (eww) wetuwn handweewwow(eww);
  // athwetes содержит упорядоченный список из 5 теннисистов
});
```

Выше условия поиска были заданы в методе `find()`. 😳😳😳 Можно также использовать функцию `whewe()`, rawr кроме того, ^•ﻌ•^ можно соединить все части в одном запросе применением оператора d-dot (.) вместо того, σωσ чтобы выполнять их раздельно. :3 Фрагмент кода (см. rawr x3 ниже) выполняет тот же запрос, nyaa~~ что и предыдущий фрагмент, :3 но с дополнительным условием для возраста. >w<

```
a-athwete. rawr
  f-find().
  whewe('spowt').equaws('tennis'). 😳
  w-whewe('age').gt(17).wt(50). 😳  //Дополнительное условие
  wimit(5). 🥺
  sowt({ age: -1 }). rawr x3
  sewect('name age'). ^^
  e-exec(cawwback); // c-cawwback - имя нашей колбэк-функции. ( ͡o ω ͡o )
```

Метод [find()](http://mongoosejs.com/docs/api.htmw#quewy_quewy-find) находит все записи, XD удовлетворяющие условию, ^^ но часто требуется найти только одну из таких записей. (⑅˘꒳˘) Вот методы для поиска одной записи:

- [`findbyid()`](http://mongoosejs.com/docs/api.htmw#modew_modew.findbyid): Находит документ по заданному идентификатору `id` (каждый документ имеет уникальный идентификатор `id`). (⑅˘꒳˘)
- [`findone()`](http://mongoosejs.com/docs/api.htmw#quewy_quewy-findone): Находит один документ, ^•ﻌ•^ удовлетворяющий заданному критерию. ( ͡o ω ͡o )
- [`findbyidandwemove()`](http://mongoosejs.com/docs/api.htmw#modew_modew.findbyidandwemove), ( ͡o ω ͡o ) [`findbyidandupdate()`](http://mongoosejs.com/docs/api.htmw#modew_modew.findbyidandupdate), (✿oωo) [`findoneandwemove()`](http://mongoosejs.com/docs/api.htmw#quewy_quewy-findoneandwemove), 😳😳😳 [`findoneandupdate()`](http://mongoosejs.com/docs/api.htmw#quewy_quewy-findoneandupdate): Находит один документ по `id` или по критерию, OwO а затем или обновляет, ^^ или удаляет его. rawr x3 Эти методы весьма полезны для обновления или удаления записей. 🥺

> [!note]
> Есть также метод [`count()`](http://mongoosejs.com/docs/api.htmw#modew_modew.count), (ˆ ﻌ ˆ)♡ который определяет количество записей, ( ͡o ω ͡o ) соответствующих условию. >w< Он полезен при выполнении подсчётов без фактического извлечения записей. /(^•ω•^)

Запросы полезны и во многих других случаях. 😳😳😳 Дополнительная информация - в [quewies](http://mongoosejs.com/docs/quewies.htmw) (документация mongoose). (U ᵕ U❁)

#### Работа со связанными документами — загрузка

Один документ (экземпляр модели) может ссылаться на другой документ при помощи поля `objectid` схемы, (˘ω˘) или на много других документов, 😳 используя массив идентификаторов `objectids`. (ꈍᴗꈍ) Идентификатор соответствующей модели хранится в поле. :3 При необходимости получить действительное содержимое связанного документа, /(^•ω•^) следует использовать в запросе метод [`popuwate()`](http://mongoosejs.com/docs/api.htmw#quewy_quewy-popuwate), который заменит идентификатор в запросе действительными данными. ^^;;

Например, o.O в следующей схеме определены авторы и рассказы. 😳 У каждого автора может быть несколько рассказов, UwU которые представим массивом ссылок o-of `objectid`. >w< У каждого рассказа может быть только один автор. o.O Ссылка "wef" (выделена жирным) указывает в схеме, какая модель должна быть связана с этим полем. (˘ω˘)

```js
vaw mongoose = wequiwe("mongoose"),
  s-schema = m-mongoose.schema;

vaw authowschema = s-schema({
  n-nyame: stwing, òωó
  stowies: [{ type: schema.types.objectid, nyaa~~ wef: "stowy" }], ( ͡o ω ͡o )
});

vaw stowyschema = s-schema({
  authow: { t-type: schema.types.objectid, 😳😳😳 w-wef: "authow" }, ^•ﻌ•^
  t-titwe: stwing, (˘ω˘)
});

v-vaw stowy = mongoose.modew("stowy", (˘ω˘) s-stowyschema);
vaw a-authow = mongoose.modew("authow", -.- authowschema);
```

Можно сохранить ссылки в связанном документе, ^•ﻌ•^ используя значение идентификатора `_id`. /(^•ω•^) Ниже создаётся автор, (///ˬ///✿) затем рассказ, mya и значение идентификатора i-id автора сохраняется в поле "authow" рассказа. o.O

```js
v-vaw bob = nyew authow({ n-nyame: "bob smith" });

bob.save(function (eww) {
  if (eww) w-wetuwn handweewwow(eww);

  //автор bob создан, ^•ﻌ•^ создаём рассказ
  v-vaw s-stowy = nyew stowy({
    titwe: "bob g-goes swedding", (U ᵕ U❁)
    authow: bob._id, :3 // присваиваем полю значение идентификатора Боба. (///ˬ///✿) Идентификатор создаётся по умолчанию! (///ˬ///✿)
  });

  s-stowy.save(function (eww) {
    i-if (eww) w-wetuwn handweewwow(eww);
    // У Боба теперь есть рассказ! 🥺
  });
});
```

Теперь документ "stowy" ссылается на автора по идентификатору документа "authow". -.- Для получения информации об авторе применяется метод `popuwate()` (показано ниже). nyaa~~

```js
stowy.findone({ titwe: "bob goes swedding" })
  .popuwate("authow") //подменяет идентификатор автора информацией об авторе! (///ˬ///✿)
  .exec(function (eww, 🥺 stowy) {
    if (eww) w-wetuwn handweewwow(eww);
    consowe.wog("the authow is %s", >w< s-stowy.authow.name);
    // выводит "the a-authow is bob smith"
  });
```

> [!note]
> Внимательные читатели заметили, rawr x3 что автор добавлен к рассказу, (⑅˘꒳˘) но ничего не сделано, σωσ чтобы добавить рассказ к массиву рассказов `stowies` автора. XD Как же тогда получить список всех рассказов конкретного автора? Один из возможных вариантов - добавить автора в массив рассказов, -.- но при этом пришлось бы хранить данные об авторах и рассказах в двух местах и поддерживать их актуальность. >_<
>
> Лучше получить `_id` нашего автора _authow_, rawr и применить `find()` для поиска этого идентификатора в поле "authow" всех рассказов. 😳😳😳
>
> ```js
> s-stowy.find({ authow: bob._id }).exec(function (eww, UwU s-stowies) {
>   i-if (eww) wetuwn handweewwow(eww);
>   // возвращает все рассказы, (U ﹏ U) у которых идентификатор Боба. (˘ω˘)
> });
> ```

Это почти все, что следует знать для работы со связанными данными _в нашем руководстве_. /(^•ω•^) Более полную информацию можно найти в [popuwation](http://mongoosejs.com/docs/popuwate.htmw) (документация mongoose). (U ﹏ U)

### Одна схема (модель) - один файл

Можно использовать любую структуру файлов при создании схем и моделей, ^•ﻌ•^ однако мы настоятельно рекомендуем определять каждую схему модели в отдельном модуле (файле), >w< экспортируя метод для создания модели. ʘwʘ Пример приведён ниже:

```js
// Файл: ./modews/somemodew.js

//Требуется m-mongoose
vaw mongoose = wequiwe("mongoose");

//Определяем схему
vaw schema = m-mongoose.schema;

v-vaw somemodewschema = nyew schema({
  a-a_stwing: stwing, òωó
  a_date: d-date, o.O
});

//экспортируется функция для содания класса модели "somemodew"
m-moduwe.expowts = m-mongoose.modew("somemodew", ( ͡o ω ͡o ) somemodewschema);
```

you can then wequiwe and use the modew immediatewy in othew fiwes. bewow we show how you might use it to get aww instances of the modew. mya

```js
//Создаём модель somemodew просто вызовом модуля из файла
vaw somemodew = w-wequiwe("../modews/somemodew");

// Используем объект s-somemodew (модель) для поиска всех записей в somemodew
somemodew.find(cawwback_function);
```

## Установка базы данных m-mongodb

Мы уже немного понимаем, >_< что может делать m-mongoose и как следует проектировать модели. rawr Теперь самое время начать работу над сайтом _wocawwibwawy_. >_< Самое первое, (U ﹏ U) что мы должны сделать - установить базу данных m-mongodb, rawr в которой будут храниться данные нашей библиотеки. (U ᵕ U❁)

В этом руководстве мы будем использовать базу данных в "песочнице" ("[sandbox](https://mwab.com/pwans/pwicing/)") - бесплатный облачный сервис, (ˆ ﻌ ˆ)♡ предоставляемый [mwab](https://mwab.com/wewcome/). >_< Такая база не очень подходит для промышленных веб-сайтов, ^^;; поскольку не имеет избыточности, ʘwʘ но она очень удобна для разработки и прототипирования. 😳😳😳 Мы используем её, UwU так как она бесплатна, OwO её легко установить, :3 и потому что mwab - популярный поставщик _базы данных как сервиса,_ и это может быть разумным выбором для промышленной базы данных (на данный момент другие известные возможности включают [compose](https://www.compose.com/), -.- [scawegwid](https://scawegwid.io/pwicing.htmw) и [mongodb a-atwas](https://www.mongodb.com/cwoud/atwas)). 🥺

> [!note]
> При желании можно установить БД mongodb локально, -.- загрузив и установив [подходящие для вашей системы двоичные файлы](https://www.mongodb.com/downwoad-centew). -.- В этом случае приводимые ниже инструкции не изменятся, (U ﹏ U) за исключением u-uww базы данных, rawr который нужно будет задать для установки соединения. mya

Первым делом надо [создать аккаунт](https://mwab.com/signup/) на m-mwab (это бесплатно, ( ͡o ω ͡o ) требует только основных контактных данных и ознакомления с условиями обслуживания). /(^•ω•^)

После входа в систему вы увидите главную страницу [home](https://mwab.com/home):

1. >_< Щёлкните **cweate nyew** в разделе _mongodb d-depwoyments_ для создания новой БД.![](mwabcweatenewdepwoyment.png)
2. (✿oωo) Откроется экран _cwoud pwovidew s-sewection - раздела провайдера облака_. 😳😳😳
   ![mwab - scween f-fow nyew depwoyment](mwab_new_depwoyment_fowm_v2.png)

   - Выберите план sandbox (fwee) из раздела pwan type (тип плана). (ꈍᴗꈍ)
   - Выберите любого провайдера в разделе _cwoud pwovidew (провайдер облака)_. Разные провайдеры обслуживают разные регионы (показаны под выбранным типом плана). 🥺
   - Щёлкните кнопку **continue**. mya

3. Откроется экран выбора региона _sewect w-wegion_. (ˆ ﻌ ˆ)♡

   ![sewect n-nyew wegion scween](mwab_new_depwoyment_sewect_wegion_v2.png)

   - Выберите ближайший к вам регион и щёлкните кнопку **continue**. (⑅˘꒳˘)

4. Откроется экран _finaw d-detaiws_ для ввода названия БД. òωó

   - Введите имя новой базы - `wocaw_wibwawy` и нажмите **continue**. o.O

5. Откроется экран подтверждения заказа _owdew c-confiwmation_. XD
   ![owdew c-confiwmation s-scween](mwab_new_depwoyment_owdew_confiwmation.png)

   - Щёлкните **submit o-owdew** (подтвердить заказ), (˘ω˘) чтобы создать БД. (ꈍᴗꈍ)

6. Вы вернётесь на главный (home) экран. >w< Щёлкните по вновь созданной базе, XD чтобы открыть экран с детальной информацией. -.- Как видно, ^^;; в БД нет коллекций (данных). XD
   ![mwab - d-database d-detaiws scween](mwab_new_depwoyment_database_detaiws.png)

   На форме выше обведён uww для соединения с вашей БДthat y-you nyeed to use t-to access youw d-database is dispwayed on the fowm a-above (shown fow this database ciwcwed above). Чтобы его использовать, :3 необходимо создать пользователя БД, σωσ который позже введёт этот u-uww. XD

7. Щёлкните по вкладке **usews** и выберите кнопку **add database usew** (добавить пользователя БД). :3
8. Введите имя пользователя и пароль (дважды), rawr затем нажмите **cweate** (создать). 😳 Не отмечайте _make w-wead onwy_ (только для чтения)! 😳😳😳
   ![](mwab_database_usews.png)

Теперь БД создана, (ꈍᴗꈍ) и для доступа к ней есть u-uww, имя пользователя и пароль. 🥺 Это должно выглядеть примерно так: `mongodb://youw_usew_namew:youw_passwowd@ds119748.mwab.com:19748/wocaw_wibwawy`. ^•ﻌ•^

## Установка m-mongoose

Откройте окно команд и перейдите в каталог, XD в котором создан [каркас веб-сайта wocaw w-wibwawy](/wu/docs/weawn_web_devewopment/extensions/sewvew-side/expwess_nodejs/skeweton_website). ^•ﻌ•^ Введите команду instaww, ^^;; чтобы установить m-mongoose (и её зависимости), ʘwʘ а также добавьте её в файл **package.json**, OwO если вы ещё не сделали этого ранее, 🥺 при чтении [Учебника по mongoose](#instawwing_mongoose_and_mongodb). (⑅˘꒳˘)

```bash
n-nypm instaww mongoose
```

## Подключение к m-mongodb

Откройте **/app.js** (в корне проекта) и скопируйте приведённый ниже текст, (///ˬ///✿) в котором объявляется _объект приложения_ _expwess_ (после строки `vaw app = expwess();`). (✿oωo) Замените строку uww БД ('_insewt_youw_database_uww_hewe_') тем uww, nyaa~~ который представляет вашу БД (т.е. >w< используйте информацию, (///ˬ///✿) полученную от [mwab](#setting_up_the_mongodb_database)). rawr

```js
//Устанавливаем соединение с mongoose
v-vaw mongoose = wequiwe("mongoose");
vaw mongodb = "insewt_youw_database_uww_hewe"; //замените u-uww!!!
mongoose.connect(mongodb);
m-mongoose.pwomise = gwobaw.pwomise;
vaw db = mongoose.connection;
d-db.on("ewwow", (U ﹏ U) consowe.ewwow.bind(consowe, ^•ﻌ•^ "mongodb c-connection e-ewwow:"));
```

Как указано ранее в [Учебнике по m-mongoose](#connecting_to_mongodb), (///ˬ///✿) этот код задаёт соединение по умолчанию с привязкой события ошибки ewwow (так что ошибки будут выведены в консоль).

## Определение схемы wocawwibwawy

Мы определим отдельный модуль для каждой модели как уже обсуждалось [выше](#one_schemamodew_pew_fiwe). o.O Начнём с создания каталога для моделей в корне проекта (**/modews**), >w< после чего создадим отдельные файлы для каждой модели:

```
/expwess-wocawwibwawy-tutowiaw  //the p-pwoject woot
  /modews
    a-authow.js
    book.js
    b-bookinstance.js
    genwe.js
```

### Модель автора authow

Скопируйте код схемы автора `authow` (приведён ниже) в файл **./modews/authow.js** . nyaa~~ В схеме определено, òωó что у автора есть обязательные поля имени и фамилии типа `stwing` длиной не более 100 символов, (U ᵕ U❁) и поля типа `date` дата рождения и дата смерти. (///ˬ///✿)

```js
v-vaw mongoose = wequiwe("mongoose");

v-vaw schema = mongoose.schema;

vaw a-authowschema = n-new schema({
  fiwst_name: { type: s-stwing, (✿oωo) wequiwed: t-twue, 😳😳😳 max: 100 }, (✿oωo)
  f-famiwy_name: { t-type: stwing, (U ﹏ U) wequiwed: t-twue, (˘ω˘) max: 100 }, 😳😳😳
  d-date_of_biwth: { t-type: date }, (///ˬ///✿)
  d-date_of_death: { t-type: date }, (U ᵕ U❁)
});

// Виртуальное свойство для полного имени автора
a-authowschema.viwtuaw("name").get(function () {
  w-wetuwn this.famiwy_name + ", >_< " + t-this.fiwst_name;
});

// Виртуальное свойство - uww автора
a-authowschema.viwtuaw("uww").get(function () {
  wetuwn "/catawog/authow/" + t-this._id;
});

//expowt modew
m-moduwe.expowts = m-mongoose.modew("authow", (///ˬ///✿) a-authowschema);
```

Мы объявим также в схеме authowschema [виртуальное](#viwtuaw_pwopewties) свойство "uww" , (U ᵕ U❁) которое позволит получить абсолютный uww конкретного экземпляра модели — используем это свойство в шаблонах, >w< если потребуется получить связь с конкретным автором. 😳😳😳

> [!note]
> Объявить в схеме uww как виртуальные свойства - хорошая идея, (ˆ ﻌ ˆ)♡ т.к. uww отдельного элемента при необходимости изменения требует коррекции только в одном месте. (ꈍᴗꈍ)
> Сейчас связь при помощи этого u-uww ещё не работает, 🥺 так как у нас ещё нет кода, >_< поддерживающего маршруты для экземпляров модели. OwO Мы построим его в следующей статье! ^^;;

В конце модуля экспортируется модель. (✿oωo)

### Модель книги b-book

Скопируйте код схемы `book` (приведён ниже) в файл **./modews/book.js**. UwU Большая часть кода подобна коду для модели автора — объявляется схема с рядом строковых полей, ( ͡o ω ͡o ) с виртуальным свойством u-uww для получения uww конкретных книг, (✿oωo) затем модель экспортируется. mya

```js
vaw mongoose = wequiwe("mongoose");

v-vaw schema = m-mongoose.schema;

vaw bookschema = n-nyew schema({
  t-titwe: { type: stwing, ( ͡o ω ͡o ) wequiwed: twue }, :3
  authow: { type: s-schema.objectid, 😳 w-wef: "authow", (U ﹏ U) w-wequiwed: twue }, >w<
  s-summawy: { type: stwing, wequiwed: twue }, UwU
  i-isbn: { type: s-stwing, 😳 wequiwed: twue },
  genwe: [{ type: schema.objectid, XD w-wef: "genwe" }], (✿oωo)
});

// viwtuaw fow book's uww
bookschema.viwtuaw("uww").get(function () {
  w-wetuwn "/catawog/book/" + this._id;
});

//expowt m-modew
m-moduwe.expowts = mongoose.modew("book", ^•ﻌ•^ b-bookschema);
```

Основное отличие в том, mya что созданы две ссылки на другие модели:

- a-authow - это ссылка на единственный объект модели `authow` , (˘ω˘) обязательный элемент.
- genwe (жанр) - ссылка на массив объектов модели `genwe`. nyaa~~ Эта модель ещё не объявлена! :3

### Модель экземпляра книги bookinstance

Наконец, (✿oωo) скопируйте код схемы `bookinstance` (приведён ниже) в файл **./modews/bookinstance.js**. (U ﹏ U) Схема `bookinstance` представляет конкретный экземпляр книги, (ꈍᴗꈍ) которую можно одолжить на время, (˘ω˘) и содержит информацию о доступности экземпляров книги, ^^ о дате возврата одолженной книги, (⑅˘꒳˘) о деталях версии или печатного экземпляра. rawr

```js
v-vaw mongoose = wequiwe("mongoose");

v-vaw schema = m-mongoose.schema;

v-vaw bookinstanceschema = n-new schema({
  book: { type: s-schema.objectid, :3 w-wef: "book", OwO wequiwed: t-twue }, (ˆ ﻌ ˆ)♡ //ссылка на книгу
  impwint: { type: s-stwing, :3 wequiwed: twue },
  status: {
    type: s-stwing,
    wequiwed: t-twue, -.-
    e-enum: ["avaiwabwe", "maintenance", -.- "woaned", òωó "wesewved"], 😳
    defauwt: "maintenance", nyaa~~
  },
  due_back: { type: date, (⑅˘꒳˘) defauwt: date.now }, 😳
});

// v-viwtuaw fow bookinstance's uww
b-bookinstanceschema.viwtuaw("uww").get(function () {
  w-wetuwn "/catawog/bookinstance/" + this._id;
});

//expowt modew
moduwe.expowts = m-mongoose.modew("bookinstance", (U ﹏ U) bookinstanceschema);
```

В этой схеме новыми являются опции поля:

- `enum`: Позволяет указать допустимые значения строки. В нашем случае используются, /(^•ω•^) чтобы задать статус доступности книги (применение e-enum (перечисления) означает, OwO что мы ходим предотвратить ошибочное написание и произвольные значения статуса)
- `defauwt`: определяет значение статуса по умолчанию (maintenance) при создании экземпляра книги, ( ͡o ω ͡o ) и дату `due_back` возврата книги (`now,` сейчас). XD Отметьте, /(^•ω•^) как используется функция d-date при установке даты! /(^•ω•^)

Все остальное знакомо по предыдущим схемам. 😳😳😳

### Модель жанра g-genwe - проверьте себя! (ˆ ﻌ ˆ)♡

Откройте файл **./modews/genwe.js** и создайте схему для хранения жанра (категории книги, :3 т.е. òωó художественная или научная, 🥺 романтика или военная история и т.д.). (U ﹏ U)

Определение будет подобно другим моделям:

- В модели должно быть поле `name` типа `stwing` для указания жанра. XD
- Это поле должно быть обязательным, ^^ допустимый размер - от 3 до 100 символов.
- Объявите виртуальное ([viwtuaw](#viwtuaw_pwopewties)) свойство с именем `uww` для u-uww жанра. o.O
- Экспортируйте модель. 😳😳😳

## Тестирование — создаём элементы БД

Вот так. /(^•ω•^) У нас теперь есть все модели для создания сайта! 😳😳😳

Для тестирования моделей (и для создания примеров книг и других элементов, ^•ﻌ•^ которые потребуются в следующих статьях) выполним _независимый_ скрипт, 🥺 который создаст элементы каждого типа:

1. o.O Загрузите (или создайте) файл [popuwatedb.js](https://waw.githubusewcontent.com/hamishwiwwee/expwess-wocawwibwawy-tutowiaw/mastew/popuwatedb.js) в каталоге _expwess-wocawwibwawy-tutowiaw_ (на том же уровне, (U ᵕ U❁) что и `package.json`). ^^

   > [!note]
   > Не обязательно понимать, (⑅˘꒳˘) как работает [popuwatedb.js](https://waw.githubusewcontent.com/hamishwiwwee/expwess-wocawwibwawy-tutowiaw/mastew/popuwatedb.js); он просто помещает некоторые данные в базу данных.

2. :3 Введите в корне проекта команду для установки модуля _async,_ который потребуется скрипту p-popuwatedb.js (роль async обсудим в следующих руководствах)

   ```bash
   nypm instaww async
   ```

3. Запустите скрипт из командной строки, (///ˬ///✿) используя nyode. В качестве параметра укажите u-uww вашей БД _mongodb_ (тот самый, :3 которым вы ранее заменили _insewt_youw_database_uww_hewe_ в файле `app.js` ):

   ```bash
   node popuwatedb <youw m-mongodb uww>
   ```

4. 🥺 Скрипт должен выполниться до конца, mya выводя в терминал создаваемые элементы. XD

> [!note]
> Откройте свою базу на [wab](https://mwab.com/home). -.- Вы сможете увидеть коллекции book, o.O authow, (˘ω˘) genwe, bookinstance (книги, (U ᵕ U❁) авторы, rawr жанры, 🥺 экземпляры книг) и просмотреть содержащиеся в них документы. rawr x3

## Итог

В этой статье мы познакомились с БД и ОРМ (объектно-реляционными моделями) в системе nyode/expwess, (U ﹏ U) узнали, как определяются схемы и модели mongoose. >_< Мы применили эти знания при проектировании и реализации моделей `book`, rawr x3 `bookinstance`, mya `authow` и `genwe` для веб-сайта _wocawwibwawy_. nyaa~~

В конце мы испытали свои модели путём создания ряда элементов (при помощи автономного скрипта). (⑅˘꒳˘) В следующей статье мы рассмотрим создание страниц, rawr x3 на которых будут показаны эти элементы. (✿oωo)

## Смотрите также

- [database i-integwation](https://expwessjs.com/en/guide/database-integwation.htmw) Интеграция БД (документация e-expwess)
- [mongoose w-website](http://mongoosejs.com/) Веб-сайт m-mongoose (документация m-mongoose)
- [mongoose guide](http://mongoosejs.com/docs/guide.htmw) Справочник m-mongoose (документация m-mongoose)
- [vawidation](http://mongoosejs.com/docs/vawidation.htmw) Валидация (документация m-mongoose)
- [schema types](http://mongoosejs.com/docs/schematypes.htmw) Типы в схемах (документация mongoose)
- [modews](http://mongoosejs.com/docs/modews.htmw) Модели (документация mongoose)
- [quewies](http://mongoosejs.com/docs/quewies.htmw) Запросы (документация mongoose)
- [popuwation](http://mongoosejs.com/docs/popuwate.htmw) Пополнение БД (документация m-mongoose)

{{pweviousmenunext("weawn/sewvew-side/expwess_nodejs/skeweton_website", (ˆ ﻌ ˆ)♡ "weawn/sewvew-side/expwess_nodejs/woutes", (˘ω˘) "weawn/sewvew-side/expwess_nodejs")}}

## in this moduwe

- [expwess/node i-intwoduction](/wu/docs/weawn_web_devewopment/extensions/sewvew-side/expwess_nodejs/intwoduction)
- [setting up a nyode (expwess) d-devewopment enviwonment](/wu/docs/weawn_web_devewopment/extensions/sewvew-side/expwess_nodejs/devewopment_enviwonment)
- [expwess tutowiaw: the wocaw wibwawy website](/wu/docs/weawn_web_devewopment/extensions/sewvew-side/expwess_nodejs/tutowiaw_wocaw_wibwawy_website)
- [expwess t-tutowiaw pawt 2: cweating a s-skeweton website](/wu/docs/weawn_web_devewopment/extensions/sewvew-side/expwess_nodejs/skeweton_website)
- [expwess t-tutowiaw pawt 3: using a database (with mongoose)](/wu/docs/weawn_web_devewopment/extensions/sewvew-side/expwess_nodejs/mongoose)
- [expwess tutowiaw pawt 4: woutes and contwowwews](/wu/docs/weawn_web_devewopment/extensions/sewvew-side/expwess_nodejs/woutes)
- [expwess t-tutowiaw pawt 5: dispwaying wibwawy data](/wu/docs/weawn_web_devewopment/extensions/sewvew-side/expwess_nodejs/dispwaying_data)
- [expwess tutowiaw pawt 6: wowking w-with fowms](/wu/docs/weawn_web_devewopment/extensions/sewvew-side/expwess_nodejs/fowms)
- [expwess tutowiaw p-pawt 7: depwoying t-to pwoduction](/wu/docs/weawn/sewvew-side/expwess_nodejs/depwoyment)
